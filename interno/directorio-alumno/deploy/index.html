<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Directorio de alumnos</title>
  <style>
    :root {
      --bg: #f5f7fb;
      --card: #ffffff;
      --text: #1f2d3d;
      --muted: #5f6b7a;
      --border: #e5e9f2;
      --brand: #0f6fff;
      --star: #f5c33b;
      --shadow: 2px 2px 6px rgba(16, 24, 40, .15);
      
      --radius: 24px;
      corner-shape: squircle;    /* forma tipo ‚Äúsquircle‚Äù */
      /* --radius-sm: 12px; */
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
    }

    body {
      margin: 0;
      padding: 0 20px 88px;
      background: var(--bg);
      color: var(--text);
      font: 400 16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      position: relative;
      overflow-x: hidden;
    }

    body::before,
    body::after {
      content: "";
      position: fixed;
      inset: -30%;
      pointer-events: none;
      z-index: 0;
      filter: blur(90px);
      opacity: .65;
      transform: translate3d(0, 0, 0);
      transition: opacity .4s ease;
    }

    body::before {
      background:
        radial-gradient(circle at 25% 30%, rgba(255, 214, 255, .9), transparent 45%),
        radial-gradient(circle at 70% 20%, rgba(189, 224, 254, .9), transparent 40%),
        radial-gradient(circle at 40% 75%, rgba(189, 246, 199, .85), transparent 45%);
      animation: floatOne 22s ease-in-out infinite alternate;
    }

    body::after {
      background:
        radial-gradient(circle at 80% 70%, rgba(255, 231, 206, .9), transparent 40%),
        radial-gradient(circle at 20% 80%, rgba(215, 219, 255, .85), transparent 38%),
        radial-gradient(circle at 55% 45%, rgba(255, 217, 227, .75), transparent 42%);
      animation: floatTwo 26s ease-in-out infinite alternate;
    }

    @keyframes floatOne {
      0% {
        transform: translate3d(-5%, -2%, 0) scale(1.05);
      }

      50% {
        transform: translate3d(4%, 3%, 0) scale(1.08);
      }

      100% {
        transform: translate3d(-3%, 6%, 0) scale(1.02);
      }
    }

    @keyframes floatTwo {
      0% {
        transform: translate3d(6%, -4%, 0) scale(1.07);
      }

      50% {
        transform: translate3d(-3%, 5%, 0) scale(1.04);
      }

      100% {
        transform: translate3d(5%, 2%, 0) scale(1.1);
      }
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      position: relative;
      z-index: 1;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 20;
      padding: 16px 24px 12px;
      width: 100vw;
      margin-left: calc(50% - 50vw);
      background: linear-gradient(180deg, rgba(245, 247, 251, 0.5) 0%, rgba(245, 247, 251, 0) 100%);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      box-sizing: border-box;
    }

    .header-inner {
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
      display: flex;
      align-items: center;
      gap: 24px;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    h1 {
      margin: 0;
      font-weight: 800;
      letter-spacing: -.02em;
      color: #263445;
      flex: 1 1 auto;
      min-width: 220px;
    }

    .filter-panel {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: flex-end;
      width: min(640px, 80vw);
      flex: 1 1 80px;
    }

    .searchbar {
      position: relative;
      width: 100%;
    }

    .searchbar input {
      width: 100%;
      font-size: 24px;
      padding: 12px 40px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fdfefe;
      outline: 0.2px solid gray;
      box-shadow:
        inset 0px 0px 4px rgba(15, 23, 42, .3),
        0 1px 1px rgba(16, 24, 40, .04);
    }

    .searchbar input::placeholder {
      color: #9aa5b5;
      opacity: 0.9;
      font-size: 16px;
      line-height: 24px;
    }

    .searchbar svg {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #98a2b3;
    }

    .facet-board {
      margin: 0;
      padding: 0;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      width: 100%;
    }

    .facet-line {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
    }

    .facet-links {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .facet-sep {
      color: var(--muted);
      font-weight: 700;
    }

    .facet-pill {
      border: none;
      background: transparent;
      color: var(--brand);
      padding: 4px 6px;
      font-size: .95rem;
      cursor: pointer;
      border-radius: 6px;
      transition: color .15s ease, background .15s ease;
    }

    .facet-pill:hover {
      color: #0b56c8;
      text-decoration: underline;
      background: rgba(15, 111, 255, .05);
    }

    .facet-pill.active {
      color: #0b56c8;
      font-weight: 700;
      text-decoration: underline;
      background: rgba(15, 111, 255, .12);
    }

    .facet-empty {
      color: var(--muted);
      font-size: .9rem;
    }

    section {
      margin-top: 10px;
      padding-top: 12px;
    }

    .section-title {
      display: flex;
      align-items: baseline;
      gap: 8px;
      color: #2b3b4f;
      margin: 0 0 12px 6px;
    }

    .section-title small {
      color: #98a2b3;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 18px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
      position: relative;
      min-height: 150px;
      display: grid;
      grid-template-columns: 56px 1fr;
      column-gap: 14px;
      align-content: start;
    }

    .avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      overflow: hidden;
      display: grid;
      place-items: center;
      border: 3px solid #fff;
      box-shadow: 0 2px 6px rgba(16, 24, 40, .10);
    }

    .avatar img {
      width: 56px;
      height: 56px;
      object-fit: cover;
      display: block;
    }

    .avatar .initials {
      font-weight: 700;
      color: #fff;
      text-shadow: 0 1px 0 rgba(0, 0, 0, .12);
    }

    .content {
      flex: 1;
      min-width: 0;
    }

    .name {
      margin: 0 26px 8px 0;
      font-weight: 800;
      color: #2b3b4f;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: block;
    }

    .meta {
      margin: 2px 0;
      color: var(--muted);
    }

    .meta b {
      color: #2b3b4f;
    }

    .whatsapp-link {
      color: #22c35e;
      font-weight: 700;
      text-decoration: none;
    }

    .whatsapp-link:hover {
      text-decoration: underline;
    }

    .courses {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      grid-column: 1 / -1;
    }

    .course-line {
      font-size: .92rem;
      padding: 0px 6px;
      align-items: center;
      small { color: gray; }
    }

    .tp-link {
      margin-left: 6px;
      font-weight: 700;
      color: var(--brand);
      text-decoration: none;
    }

    .tp-link:hover {
      text-decoration: underline;
    }

    .course-line .emoji {
      flex: 0 0 18px;
    }

    .course-line .practicos {
      margin-top: 4px;
      font-size: 6px;
      color: #475569;
      background: #f1f5f9;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 4px 6px;
    }

    .muted {
      color: #98a2b3;
    }

    .empty {
      padding: 16px;
      color: #98a2b3;
    }

    .footer-note {
      position: fixed;
      left: 50%;
      bottom: 12px;
      transform: translateX(-50%);
      background: linear-gradient(180deg, rgba(245, 247, 251, 0.5) 0%, rgba(245, 247, 251, 0) 100%);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      box-shadow: 0 8px 20px rgba(15, 23, 42, .12);
      color: #98a2b3;
      font-size: .9rem;
      z-index: 10;
      text-align: center;
      white-space: nowrap;
    }

    #avatar-zoom {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, .58);
      display: none;
      place-items: center;
      z-index: 999;
      backdrop-filter: blur(3px);
      cursor: zoom-out;
    }

    #avatar-zoom.active {
      display: grid;
      animation: fadeIn .18s ease-out
    }

    #avatar-zoom .zoom-frame {
      width: min(512px, 80vw);
      height: min(512px, 80vw);
      border-radius: 50%;
      overflow: hidden;
      box-shadow: 0 18px 50px rgba(0, 0, 0, .28);
      background: var(--card);
      border: 4px solid #fff;
      display: grid;
      place-items: center;
      transform: scale(.9) translateY(6px);
      opacity: 0;
      animation: zoomPop .22s cubic-bezier(.18, .89, .32, 1.28) forwards;
      animation-play-state: paused
    }

    #avatar-zoom.active .zoom-frame {
      animation-play-state: running
    }

    #avatar-zoom img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: scale(.95)
      }

      to {
        opacity: 1;
        transform: scale(1)
      }
    }

    @keyframes zoomPop {
      0% {
        opacity: 0;
        transform: scale(.82) translateY(10px);
      }

      60% {
        opacity: 1;
        transform: scale(1.03) translateY(0);
      }

      100% {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    @media (max-width:640px) {
      body {
        padding: 0 12px 88px;
      }

      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
        margin-bottom: 0;
        padding: 10px 16px;
      }

      .searchbar {
        width: 100%;
      }

      .filter-panel,
      .facet-board {
        width: 100%;
        align-items: flex-start;
        gap: 6px;
      }

      section {
        margin-top: 0;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <div class="header-inner">
        <h1>Directorio de Alumnos</h1>
        <div class="filter-panel">
          <div class="searchbar">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15z" stroke="currentColor"
                stroke-width="2" stroke-linecap="round" />
            </svg>
            <input id="search" placeholder="Buscar por nombre, tel√©fono, legajo, materia, comisi√≥n, estado o a√±o"
              autocomplete="off" />
          </div>
          <div class="facet-board" aria-live="polite">
            <div class="facet-line">
              <div id="facet-years" class="facet-links"></div>
              <span id="facet-sep-1" class="facet-sep">‚ñ∂</span>
              <div id="facet-materias" class="facet-links"></div>
              <span id="facet-sep-2" class="facet-sep">‚ñ∂</span>
              <div id="facet-comisiones" class="facet-links"></div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <section>
      <h2 class="section-title">Contactos <small id="all-count" class="muted"></small></h2>
      <div id="contacts" class="grid"></div>
    </section>

    <p class="footer-note">Listado actualizado al <span id="last-updated" class="muted">8 de diciembre de 2025</span>.
    </p>
  </div>

  <script type="module">
    // Utilidades -----------------------------------------------------------
    const stateEmoji = new Map([
      ["Promocionado", "üü¢"],
      ["Pendiente", "üîµ"],
      ["Regular", "üü°"],
      ["Libre", "üî¥"],
      ["Cursando", "‚ö™Ô∏è"],
    ]);

    const norm = (s) => (s || "")
      .toString()
      .toLowerCase()
      .normalize('NFD')
      .replace(/\p{Diacritic}/gu, '')
      .replace(/[^a-z0-9 @._+\-]+/g, ' ')
      .trim();

    function initials(fullName) {
      if (!fullName) return "?";
      const [ap, nom] = fullName.split(",");
      const first = (nom || "").trim().split(/\s+/)[0] || "";
      const last = (ap || "").trim().split(/\s+/)[0] || "";
      return (first[0] || "") + (last[0] || "");
    }

    function colorFor(text) {
      let h = 0; for (let i = 0; i < text.length; i++) h = (h * 31 + text.charCodeAt(i)) >>> 0;
      h = h % 360; const s = 70, l = 50;
      return `linear-gradient(135deg, hsl(${h},${s}%,${l + 8}%) 0%, hsl(${(h + 30) % 360},${s - 10}%,${l - 6}%) 100%)`;
    }

    function githubAvatar(username) {
      if (!username) return null;
      const u = username.replace(/^@+/, '').trim();
      const github = `https://github.com/AlejandroDiBattista/{repo}/tree/main/TP/`
      if (!u) return null;
      return `https://github.com/${encodeURIComponent(u)}.png?size=120`;
    }

    function githubTP(curso) {
      if (!curso || !curso.carpeta_tp) return null;
      const comision = curso.codigo.startsWith('L') ? `-${curso.comision}`.trim() : "";
      const repo = `TUP${Number(curso.a√±o) - 2000}-${curso.codigo}${comision}`;
      const carpeta = encodeURIComponent(curso.carpeta_tp);
      return `https://github.com/AlejandroDiBattista/${repo}/tree/main/TP/${carpeta}`;
    }

    // Overlay de zoom para avatares ------------------------------------
    const avatarZoom = (() => {
      const overlay = document.createElement('div');
      overlay.id = 'avatar-zoom';
      overlay.innerHTML = `<div class="zoom-frame"><img alt="Avatar ampliado" /></div>`;
      overlay.addEventListener('click', () => overlay.classList.remove('active'));
      document.body.appendChild(overlay);
      const img = overlay.querySelector('img');
      const show = (src, alt = 'Avatar') => {
        if (!src) return;
        img.src = src;
        img.alt = alt;
        overlay.classList.add('active');
      };
      window.addEventListener('keydown', (ev) => {
        if (ev.key === 'Escape') overlay.classList.remove('active');
      });
      return { show };
    })();

    // (Sin favoritos ni localStorage)

    // Render --------------------------------------------------------------
    function coursesForFacet(a) {
      let list = Array.isArray(a.cursos) ? a.cursos : [];
      const { year, materia, comision } = facetState;
      if (year) list = list.filter(c => String(c.a√±o) === String(year));
      if (materia) list = list.filter(c => String(c.materia) === String(materia));
      if (comision) list = list.filter(c => String(c.comision) === String(comision));

      const abbrFilters = abbrevFiltersFromQuery(document.getElementById('search').value);
      if (abbrFilters.length) {
        list = list.filter(c => abbrFilters.includes(materiaAbbreviation(c.materia).toUpperCase()));
      }
      const stateFilters = stateFiltersFromQuery(document.getElementById('search').value);
      if (stateFilters.length) {
        list = list.filter(c => {
          const st = norm(c.estado || '');
          return stateFilters.every(sf => st.startsWith(sf));
        });
      }
      return list;
    }

    function cardTemplate(a) {
      const tel = a.telefono || '';
      const waNumber = tel.replace(/\D/g, '');
      const gh = githubAvatar(a.github);

      const em = s => stateEmoji.get(s) || '‚ö™Ô∏è';

      let perfil = '';
      if (a.foto) {
        perfil = `<div class="avatar"><img alt="avatar" src="./img/${a.legajo}.png" loading="lazy" referrerpolicy="no-referrer"/></div>`;
      } else if (gh) {
        perfil = `<div class="avatar"><img alt="avatar" src="${gh}" loading="lazy" referrerpolicy="no-referrer"/></div>`
      } else {
        perfil = `<div class="avatar" style="background:${colorFor(a.nombre || a.legajo)}"><span class="initials">${initials(a.nombre).toUpperCase()}</span></div>`;
      }
      const avatarHtml = perfil;
      const telefonoHtml = tel ? `<p class="meta"><b>Tel:</b> <a class="whatsapp-link" href="https://wa.me/${waNumber}" target="_blank" rel="noopener">${tel}</a></p>` : '';

      const practicos = (curso) => {
        let salida = '';
        for (const [key, value] of Object.entries(curso)) {
          if (key.startsWith('TP') && value) {
            salida += value + ' ';
          }
        }
        if (salida) {
          return `<div class="practicos">Pr√°cticos: ${salida}</div>`;
        } else {
          return '';
        }
      };

      const cursosFiltrados = coursesForFacet(a);
      const cursos = cursosFiltrados.map(c => {
        const repoUrl = githubTP(c);
        const link = repoUrl ? ` ¬∑ <a class="tp-link" href="${repoUrl}" target="_blank" rel="noopener">TP</a>` : '';
        return `
          <div class="course-line" style="flex-direction:column; align-items:flex-start;">
            <div><span class="emoji">${em(c.estado)}</span> <span>${c.a√±o} ¬∑ ${c.materia} ¬∑ ${c.comision} <small>${c.estado}</small>${link}</span></div>
            ${practicos(c)}
          </div>
        `;
      }).join('');
      const cursosHtml = cursos || `<div class="course-line muted">Sin cursos en esta faceta</div>`;
      return `
          <article class="card" data-legajo="${a.legajo}">
            ${avatarHtml}
            <div class="content">
              <h3 class="name" title="${(a.nombre || '').replace(/&/g, '&amp;').replace(/\"/g, '&quot;')}">${a.nombre || 'Sin nombre'}</h3>
              <p class="meta"><b>Legajo:</b> ${a.legajo}</p>
              ${telefonoHtml}
            </div>
            <div class="courses">${cursosHtml}</div>
          </article>`;
    }

    function mountCards(container, list) {
      container.innerHTML = list.length ? list.map(cardTemplate).join('') : `<div class="empty">Sin resultados</div>`;
      // (Sin manejadores de favoritos)
      // Fallback a iniciales si el avatar de GitHub falla
      container.querySelectorAll('.avatar img').forEach(img => {
        img.addEventListener('error', () => {
          const card = img.closest('.card');
          const name = card?.querySelector('.name')?.textContent || '';
          const wrapper = img.parentElement;
          if (wrapper) {
            wrapper.innerHTML = `<span class="initials">${initials(name).toUpperCase()}</span>`;
            wrapper.style.background = colorFor(name);
          }
        }, { once: true });

        img.addEventListener('click', (ev) => {
          ev.stopPropagation();
          avatarZoom.show(img.src, img.alt || 'Avatar');
        });
      });
    }

    function asArray(dict) { return Object.values(dict || {}); }

    const ABBREV_REGEX = /^(p|l)(\d+)$/i;
    const SPECIAL_QUERY_TOKENS = new Set(['f+', 'f-', 't+', 't-', 'g+', 'g-']);

    function flagFilterFromTokens(tokens, yes, no) {
      const hasYes = tokens.includes(yes);
      const hasNo = tokens.includes(no);
      if (hasYes && hasNo) return null;
      if (hasYes) return true;
      if (hasNo) return false;
      return null;
    }

    function photoFilterFromTokens(tokens) {
      return flagFilterFromTokens(tokens, 'f+', 'f-');
    }

    function phoneFilterFromTokens(tokens) {
      return flagFilterFromTokens(tokens, 't+', 't-');
    }

    function githubFilterFromTokens(tokens) {
      return flagFilterFromTokens(tokens, 'g+', 'g-');
    }

    function abbrevFiltersFromQuery(q) {
      return norm(q).split(/\s+/).filter(Boolean).filter(t => ABBREV_REGEX.test(t)).map(t => t.toUpperCase());
    }

    function materiaFromAbbr(abbr, year) {
      if (!abbr) return null;
      const upper = abbr.toUpperCase();
      const set = new Set();
      ALL.forEach(a => (a.cursos || []).forEach(c => {
        if (upper === materiaAbbreviation(c.materia).toUpperCase() && (!year || String(c.a√±o) === String(year))) {
          set.add(String(c.materia));
        }
      }));
      const list = [...set].sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
      return list[0] || null;
    }

    function comisionFromToken(token, year, materia) {
      if (!token || !materia) return null;
      const target = norm(token);
      const set = new Set();
      ALL.forEach(a => (a.cursos || []).forEach(c => {
        if (String(c.materia) === String(materia) && (!year || String(c.a√±o) === String(year))) {
          const comp = norm(String(c.comision || ''));
          if (comp && comp === target) set.add(String(c.comision));
        }
      }));
      const list = [...set].sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
      return list[0] || null;
    }

    const ESTADOS = ['libre', 'regular', 'promocionado', 'pendiente'];

    function expandSearchTokens(tokens) {
      const out = [];
      for (const t of tokens) {
        if (!t) continue;
        const m = t.match(ABBREV_REGEX);
        if (m) {
          const full = (m[1].toLowerCase() === 'p' ? 'programacion' : 'laboratorio') + ' ' + m[2];
          norm(full).split(/\s+/).filter(Boolean).forEach(part => out.push(part));
        } else {
          out.push(t);
        }
      }
      return out;
    }

    function stateFiltersFromQuery(q) {
      const toks = norm(q).split(/\s+/).filter(Boolean);
      return toks.filter(t => ESTADOS.some(e => e.startsWith(t)));
    }

    function materiaAbbreviation(name) {
      const normalized = norm(name);
      const regexMatch = normalized.match(/^(programacion|laboratorio)[a-z\s]*?(\d+)/);
      if (regexMatch) {
        const prefix = regexMatch[1] === 'programacion' ? 'P' : 'L';
        return `${prefix}${regexMatch[2]}`;
      }
      const m = normalized.match(/^(p|l)(\d+)/);
      if (m) {
        return m[0].toUpperCase();
      }
      return name;
    }

    function yearsForMateria(materia) {
      if (!materia) return [];
      const set = new Set();
      ALL.forEach(a => (a.cursos || []).forEach(c => {
        if (String(c.materia) === String(materia)) set.add(String(c.a√±o));
      }));
      return [...set].filter(Boolean).sort((a, b) => a.localeCompare(b, 'es', { numeric: true }));
    }

    function filterItems(items, q) {
      if (!q) return items;
      const normalizedTokens = norm(q).split(/\s+/).filter(Boolean);
      const abbrFilters = abbrevFiltersFromQuery(q);
      const stateFilters = stateFiltersFromQuery(q);
      const photoFilter = photoFilterFromTokens(normalizedTokens);
      const phoneFilter = phoneFilterFromTokens(normalizedTokens);
      const githubFilter = githubFilterFromTokens(normalizedTokens);
      const palabras = expandSearchTokens(normalizedTokens.filter(t => !SPECIAL_QUERY_TOKENS.has(t)));
      return items.filter(a => {
        const cursos = (a.cursos || []).flatMap(c => [c.materia, c.comision, c.estado, String(c.a√±o), c.codigo]);
        const base = [a.nombre, a.telefono || '', a.legajo || '', a.github || '', `${a.cursos.length}x`];
        const texto = norm(base.concat(cursos).filter(Boolean).join(' '));
        const tokens = texto.split(/\s+/).filter(Boolean);
        const hay = palabras.every(p => tokens.some(t => t.startsWith(p)));
        if (!hay) return false;
        if (photoFilter === true  && !a.foto) return false;
        if (photoFilter === false &&  a.foto) return false;
        const hasPhone = Boolean((a.telefono || '').trim());
        if (phoneFilter === true  && !hasPhone) return false;
        if (phoneFilter === false &&  hasPhone) return false;
        const hasGithub = Boolean((a.github || '').trim());
        if (githubFilter === true  && !hasGithub) return false;
        if (githubFilter === false &&  hasGithub) return false;
        if (abbrFilters.length) {
          const tieneAbbr = abbrFilters.every(abbr =>
            (a.cursos || []).some(c => materiaAbbreviation(c.materia).toUpperCase() === abbr)
          );
          if (!tieneAbbr) return false;
        }
        if (stateFilters.length) {
          const tieneEstado = stateFilters.every(sf =>
            (a.cursos || []).some(c => norm(c.estado || '').startsWith(sf))
          );
          if (!tieneEstado) return false;
        }
        // Si hay filtros de faceta/abreviatura/estado, el alumno debe tener cursos que cumplan todos
        const facetApplied = facetState.year || facetState.materia || facetState.comision || abbrFilters.length || stateFilters.length;
        if (facetApplied) {
          const courses = coursesForFacet(a);
          if (!courses.length) return false;
        }
        return hay;
      });
    }

    function sortByNombre(items) {
      return [...items].sort((a, b) => (a.nombre || '').localeCompare(b.nombre || '', 'es', { sensitivity: 'base' }));
    }

    let ALL = [];
    let DATA_LOADED = false;
    let DATA_PROMISE = null;

    function render() {
      const q = document.getElementById('search').value;
      const filtered = sortByNombre(filterItems(ALL, q));
      mountCards(document.getElementById('contacts'), filtered);
      document.getElementById('all-count').textContent = `(${filtered.length})`;
    }

    const applySearch = () => render();

    // Carga √∫nica de datos -----------------------------------------------
    function ensureDataLoaded() {
      if (DATA_LOADED) return Promise.resolve(ALL);
      if (!DATA_PROMISE) {
        const contacts = document.getElementById('contacts');
        contacts.innerHTML = '<div class="empty">Cargando datos...</div>';
        DATA_PROMISE = (async () => {
          const resp = await fetch('./alumnos.json', { cache: 'no-store' });
          if (!resp.ok) throw new Error('HTTP ' + resp.status);
          const data = await resp.json();
          ALL = asArray(data).map(a => ({
            legajo: String(a.legajo || '').trim(),
            nombre: a.nombre || '',
            telefono: a.telefono || '',
            github: a.github || '',
            foto: a.foto || false,
            cursos: Array.isArray(a.cursos) ? a.cursos : [],
          }));
          DATA_LOADED = true;
          return ALL;
        })().catch(err => {
          console.error('Error al cargar alumnos (fetch)', err);
          const container = document.getElementById('contacts');
          container.innerHTML = '<div class="empty">No se pudo cargar alumnos.json</div>';
          throw err;
        });
      }
      return DATA_PROMISE;
    }

    const searchInput = document.getElementById('search');
    const facetState = { year: null, materia: null, comision: null };
    const facetContainers = {
      years: document.getElementById('facet-years'),
      materias: document.getElementById('facet-materias'),
      comisiones: document.getElementById('facet-comisiones'),
    };
    const facetSeparators = {
      yToM: document.getElementById('facet-sep-1'),
      mToC: document.getElementById('facet-sep-2'),
    };

    function facetQueryString() {
      const materiaToken = facetState.materia ? materiaAbbreviation(facetState.materia) : null;
      return [facetState.year, materiaToken, facetState.comision].filter(Boolean).join(' ');
    }

    function validYearToken(t) {
      if (!/^\d{4}$/.test(t)) return false;
      const years = getYears();
      return years.includes(String(t));
    }

    function syncFacetsFromQuery(q) {
      if (!DATA_LOADED) return;
      const tokens = norm(q).split(/\s+/).filter(Boolean);
      const yearToken = tokens.find(validYearToken) || null;
      const abbrTokenRaw = tokens.find(t => ABBREV_REGEX.test(t)) || null;
      const abbrToken = abbrTokenRaw ? abbrTokenRaw.toUpperCase() : null;
      const comToken = tokens.find(t => /^c[\w-]+$/i.test(t)) || null;

      const materiaToken = abbrToken ? materiaFromAbbr(abbrToken, yearToken) : null;
      let resolvedYear = yearToken;
      if (!resolvedYear && materiaToken) {
        const years = yearsForMateria(materiaToken);
        if (years.length === 1) {
          resolvedYear = years[0];
        } else if (years.length > 1) {
          resolvedYear = years[years.length - 1]; // toma el a√±o m√°s reciente
        }
      }
      const comisionToken = comToken ? comisionFromToken(comToken, resolvedYear, materiaToken) : null;

      facetState.year = resolvedYear;
      facetState.materia = materiaToken;
      facetState.comision = comisionToken;
      renderFacets();
    }

    function getYears() {
      const set = new Set();
      ALL.forEach(a => (a.cursos || []).forEach(c => {
        if (c.a√±o !== undefined && c.a√±o !== null && c.a√±o !== '') {
          set.add(String(c.a√±o));
        }
      }));
      return [...set].sort((a, b) => a.localeCompare(b, 'es', { numeric: true }));
    }

    function getMaterias(year) {
      if (!year) return [];
      const set = new Set();
      ALL.forEach(a => (a.cursos || []).forEach(c => {
        if (String(c.a√±o) === String(year) && c.materia) set.add(String(c.materia));
      }));
      return [...set].sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
    }

    function getComisiones(year, materia) {
      if (!year || !materia) return [];
      const set = new Set();
      ALL.forEach(a => (a.cursos || []).forEach(c => {
        if (String(c.a√±o) === String(year) && String(c.materia) === String(materia) && c.comision) {
          set.add(String(c.comision));
        }
      }));
      return [...set].sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
    }

    function renderFacetLinks(container, values, activeValue, onClick) {
      container.innerHTML = '';
      if (!values.length) return;
      values.forEach(val => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'facet-pill' + (activeValue === val ? ' active' : '');
        btn.textContent = val;
        btn.addEventListener('click', () => onClick(val));
        container.appendChild(btn);
      });
    }

    function renderFacets() {
      if (!DATA_LOADED) return;
      facetSeparators.yToM.style.display = 'none';
      facetSeparators.mToC.style.display = 'none';
      const years = getYears();
      const yearsToShow = facetState.year ? [facetState.year] : years;
      renderFacetLinks(facetContainers.years, yearsToShow, facetState.year, toggleYear);

      if (!facetState.year) {
        facetContainers.materias.innerHTML = '';
        facetContainers.comisiones.innerHTML = '';
        return;
      }
      facetSeparators.yToM.style.display = 'inline-block';

      const materias = getMaterias(facetState.year);
      const materiasToShow = facetState.materia ? [facetState.materia] : materias;
      renderFacetLinks(facetContainers.materias, materiasToShow, facetState.materia, toggleMateria);

      if (!facetState.materia) {
        facetContainers.comisiones.innerHTML = '';
        return;
      }
      facetSeparators.mToC.style.display = 'inline-block';

      const comisiones = getComisiones(facetState.year, facetState.materia);
      const comisionesToShow = facetState.comision ? [facetState.comision] : comisiones;
      renderFacetLinks(facetContainers.comisiones, comisionesToShow, facetState.comision, toggleComision);
    }

    function syncFacetsToSearch() {
      const q = facetQueryString();
      searchInput.value = q;
      setSearchParam(q);
      if (DATA_LOADED) {
        render();
      }
    }

    function toggleYear(year) {
      if (facetState.year === year) {
        facetState.year = null;
        facetState.materia = null;
        facetState.comision = null;
      } else {
        facetState.year = year;
        facetState.materia = null;
        facetState.comision = null;
      }
      syncFacetsToSearch();
      renderFacets();
    }

    function toggleMateria(materia) {
      if (!facetState.year) return;
      if (facetState.materia === materia) {
        facetState.materia = null;
        facetState.comision = null;
      } else {
        facetState.materia = materia;
        facetState.comision = null;
      }
      syncFacetsToSearch();
      renderFacets();
    }

    function toggleComision(comision) {
      if (!facetState.year || !facetState.materia) return;
      if (facetState.comision === comision) {
        facetState.comision = null;
      } else {
        facetState.comision = comision;
      }
      syncFacetsToSearch();
      renderFacets();
    }

    function setSearchParam(q) {
      const url = new URL(window.location.href);
      if (q) {
        url.searchParams.set('q', q);
      } else {
        url.searchParams.delete('q');
      }
      window.history.replaceState({}, '', url);
    }

    function syncInputFromURL() {
      const url = new URL(window.location.href);
      const q = url.searchParams.get('q') || '';
      if (searchInput.value !== q) searchInput.value = q;
      return q;
    }

    searchInput.addEventListener('input', () => {
      const q = searchInput.value;
      setSearchParam(q);
      if (!DATA_LOADED) {
        // Evita intentar filtrar sin datos; la promesa actualizar√° despu√©s
        return;
      }
      syncFacetsFromQuery(q);
      applySearch();
    });

    window.addEventListener('popstate', () => {
      const q = syncInputFromURL();
      if (DATA_LOADED) {
        syncFacetsFromQuery(q);
        render();
      } else {
        ensureDataLoaded().then(() => {
          syncFacetsFromQuery(q);
          render();
        });
      }
    });

    function start() {
      const q = syncInputFromURL();
      ensureDataLoaded().then(() => {
        syncFacetsFromQuery(q);
        renderFacets();
        render();
      });
    }
    if (document.readyState === 'loading') {
      window.addEventListener('DOMContentLoaded', start, { once: true });
    } else {
      start();
    }
  </script>

</body>

</html>
