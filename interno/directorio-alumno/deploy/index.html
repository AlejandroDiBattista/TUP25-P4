<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Directorio de alumnos</title>
  <link rel="preconnect" href="https://github.com" crossorigin />
  <link rel="preconnect" href="https://avatars.githubusercontent.com" crossorigin />
  <style>
    :root {
      --bg: #f5f7fb;
      --card: #ffffff;
      --text: #1f2d3d;
      --muted: #5f6b7a;
      --border: #e5e9f2;
      --brand: #0f6fff;
      --star: #f5c33b;
      --shadow: 2px 2px 6px rgba(16, 24, 40, .15);
      
      --radius: 24px;
      corner-shape: squircle;    /* forma tipo ‚Äúsquircle‚Äù */
      /* --radius-sm: 12px; */
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
    }

    body {
      margin: 0;
      padding: 0 20px 40px;
      background: var(--bg);
      color: var(--text);
      font: 400 16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      position: relative;
      overflow-x: hidden;
    }

    body::before,
    body::after {
      content: "";
      position: fixed;
      inset: -30%;
      pointer-events: none;
      z-index: 0;
      filter: blur(90px);
      opacity: .65;
      transform: translate3d(0, 0, 0);
      transition: opacity .4s ease;
    }

    body::before {
      background:
        radial-gradient(circle at 25% 30%, rgba(255, 214, 255, .9), transparent 45%),
        radial-gradient(circle at 70% 20%, rgba(189, 224, 254, .9), transparent 40%),
        radial-gradient(circle at 40% 75%, rgba(189, 246, 199, .85), transparent 45%);
      animation: floatOne 22s ease-in-out infinite alternate;
    }

    body::after {
      background:
        radial-gradient(circle at 80% 70%, rgba(255, 231, 206, .9), transparent 40%),
        radial-gradient(circle at 20% 80%, rgba(215, 219, 255, .85), transparent 38%),
        radial-gradient(circle at 55% 45%, rgba(255, 217, 227, .75), transparent 42%);
      animation: floatTwo 26s ease-in-out infinite alternate;
    }

    @keyframes floatOne {
      0% {
        transform: translate3d(-5%, -2%, 0) scale(1.05);
      }

      50% {
        transform: translate3d(4%, 3%, 0) scale(1.08);
      }

      100% {
        transform: translate3d(-3%, 6%, 0) scale(1.02);
      }
    }

    @keyframes floatTwo {
      0% {
        transform: translate3d(6%, -4%, 0) scale(1.07);
      }

      50% {
        transform: translate3d(-3%, 5%, 0) scale(1.04);
      }

      100% {
        transform: translate3d(5%, 2%, 0) scale(1.1);
      }
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      position: relative;
      z-index: 1;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 20;
      padding: 16px 24px 12px;
      width: 100vw;
      margin-left: calc(50% - 50vw);
      background: linear-gradient(180deg, rgba(245, 247, 251, 0.5) 0%, rgba(245, 247, 251, 0) 100%);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      box-sizing: border-box;
    }

    .header-inner {
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
      display: flex;
      align-items: center;
      gap: 24px;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    h1 {
      margin: 0;
      font-weight: 800;
      letter-spacing: -.02em;
      color: #263445;
      flex: 1 1 auto;
      min-width: 220px;
    }

    .filter-panel {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: flex-end;
      width: min(640px, 80vw);
      flex: 1 1 80px;
    }

    .searchbar {
      position: relative;
      width: 100%;
    }

    .searchbar input {
      width: 100%;
      font-size: 24px;
      padding: 12px 40px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fdfefe;
      outline: 0.2px solid gray;
      box-shadow:
        inset 0px 0px 4px rgba(15, 23, 42, .3),
        0 1px 1px rgba(16, 24, 40, .04);
    }

    .searchbar input::placeholder {
      color: #9aa5b5;
      opacity: 0.9;
      font-size: 16px;
      line-height: 24px;
    }

    .searchbar svg {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #98a2b3;
    }

    .facet-board {
      margin: 0;
      padding: 0;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      width: 100%;
    }

    .facet-line {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
    }

    .facet-links {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .facet-sep {
      color: var(--muted);
      font-weight: 700;
    }

    .facet-pill {
      border: none;
      background: transparent;
      color: var(--brand);
      padding: 4px 6px;
      font-size: .95rem;
      cursor: pointer;
      border-radius: 6px;
      transition: color .15s ease, background .15s ease;
    }

    .facet-pill:hover {
      color: #0b56c8;
      text-decoration: underline;
      background: rgba(15, 111, 255, .05);
    }

    .facet-pill.active {
      color: #0b56c8;
      font-weight: 700;
      text-decoration: underline;
      background: rgba(15, 111, 255, .12);
    }

    .facet-count {
      font-size: 0.55em;
      opacity: .65;
      margin-left: 4px;
    }

    .facet-empty {
      color: var(--muted);
      font-size: .9rem;
    }

    section {
      margin-top: 10px;
      padding-top: 12px;
    }

    .section-title {
      display: flex;
      align-items: baseline;
      gap: 8px;
      color: #2b3b4f;
      margin: 0 0 12px 6px;
    }

    .section-title small {
      color: #98a2b3;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 18px;
      padding-bottom: 80px; /* espacio para que no se solape con el pie */
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
      position: relative;
      min-height: 150px;
      display: grid;
      grid-template-columns: 56px 1fr;
      column-gap: 14px;
      align-content: start;
      outline: none;
    }

    .card.kbd-selected,
    .card:focus-visible {
      border-color: rgba(15, 111, 255, .55);
      box-shadow:
        0 0 0 4px rgba(15, 111, 255, .18),
        var(--shadow);
    }

    .card[data-copied="true"]::after {
      content: "Copiado";
      position: absolute;
      top: 10px;
      right: 12px;
      background: rgba(15, 111, 255, .10);
      border: 1px solid rgba(15, 111, 255, .25);
      color: #0b56c8;
      font-weight: 700;
      font-size: .78rem;
      padding: 4px 8px;
      border-radius: 999px;
      pointer-events: none;
    }

    .avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      overflow: hidden;
      display: grid;
      place-items: center;
      border: 3px solid #fff;
      box-shadow: 0 2px 6px rgba(16, 24, 40, .10);
    }

    .avatar img {
      width: 56px;
      height: 56px;
      object-fit: cover;
      display: block;
      cursor: pointer;
    }

    .avatar .initials {
      font-weight: 700;
      color: #fff;
      text-shadow: 0 1px 0 rgba(0, 0, 0, .12);
    }

    .content {
      flex: 1;
      min-width: 0;
    }

    .name {
      margin: 0 26px 8px 0;
      font-weight: 800;
      color: #2b3b4f;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: block;
    }

    .meta {
      margin: 2px 0;
      color: var(--muted);
    }

    .meta b {
      color: #2b3b4f;
    }

    .whatsapp-link {
      color: #22c35e;
      font-weight: 700;
      text-decoration: none;
    }

    .whatsapp-link:hover {
      text-decoration: underline;
    }

    .courses {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      grid-column: 1 / -1;
    }

    .course-line {
      font-size: .92rem;
      padding: 0px 6px;
      align-items: center;
      small { color: gray; }
    }

    .tp-link {
      margin-left: 6px;
      font-weight: 700;
      color: var(--brand);
      text-decoration: none;
    }

    .tp-link:hover {
      text-decoration: underline;
    }

    .course-line .emoji {
      flex: 0 0 18px;
    }

    .course-line .practicos {
      margin-top: 4px;
      font-size: 6px;
      color: #475569;
      background: #f1f5f9;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 4px 6px;
    }

    .muted {
      color: #98a2b3;
    }

    .empty {
      padding: 16px;
      color: #98a2b3;
    }

    .typeahead-hit {
      background: #fff6a5;
      color: inherit;
      border-radius: 4px;
      padding: 0 0px;
    }

    .footer-note {
      position: fixed;
      left: 50%;
      bottom: 12px;
      transform: translateX(-50%);
      background: linear-gradient(180deg, rgba(245, 247, 251, 0.5) 0%, rgba(245, 247, 251, 0) 100%);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      box-shadow: 0 8px 20px rgba(15, 23, 42, .12);
      color: #98a2b3;
      font-size: .9rem;
      z-index: 10;
      text-align: center;
      white-space: nowrap;
    }

    #avatar-zoom {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, .58);
      display: none;
      place-items: center;
      z-index: 999;
      backdrop-filter: blur(3px);
      cursor: zoom-out;
    }

    #avatar-zoom.active {
      display: grid;
      animation: fadeIn .18s ease-out
    }

    #avatar-zoom .zoom-frame {
      width: min(512px, 80vw);
      height: min(512px, 80vw);
      border-radius: 50%;
      overflow: hidden;
      box-shadow: 0 18px 50px rgba(0, 0, 0, .28);
      background: var(--card);
      border: 4px solid #fff;
      display: grid;
      place-items: center;
      transform: scale(.9) translateY(6px);
      opacity: 0;
      animation: zoomPop .22s cubic-bezier(.18, .89, .32, 1.28) forwards;
      animation-play-state: paused
    }

    #avatar-zoom.active .zoom-frame {
      animation-play-state: running
    }

    #avatar-zoom img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: scale(.95)
      }

      to {
        opacity: 1;
        transform: scale(1)
      }
    }

    @keyframes zoomPop {
      0% {
        opacity: 0;
        transform: scale(.82) translateY(10px);
      }

      60% {
        opacity: 1;
        transform: scale(1.03) translateY(0);
      }

      100% {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    @media (max-width:640px) {
      body {
        padding: 0 12px 40px;
      }

      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
        margin-bottom: 0;
        padding: 10px 16px;
      }

      .searchbar {
        width: 100%;
      }

      .filter-panel,
      .facet-board {
        width: 100%;
        align-items: flex-start;
        gap: 6px;
      }

      section {
        margin-top: 0;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <div class="header-inner">
        <h1>Directorio de Alumnos</h1>
        <div class="filter-panel">
          <div class="searchbar">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15z" stroke="currentColor"
                stroke-width="2" stroke-linecap="round" />
            </svg>
            <input id="search" placeholder="Buscar por nombre, tel√©fono, legajo, materia, comisi√≥n, estado o a√±o"
              autocomplete="off" />
          </div>
          <div class="facet-board" aria-live="polite">
            <div class="facet-line">
              <div id="facet-years" class="facet-links"></div>
              <span id="facet-sep-1" class="facet-sep">‚ñ∂</span>
              <div id="facet-materias" class="facet-links"></div>
              <span id="facet-sep-2" class="facet-sep">‚ñ∂</span>
              <div id="facet-comisiones" class="facet-links"></div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <section>
      <h2 class="section-title">Contactos <small id="all-count" class="muted"></small></h2>
      <div id="contacts" class="grid"></div>
    </section>

    <p class="footer-note">Listado actualizado al <span id="last-updated" class="muted">18 de diciembre de 2025</span>.
    </p>
  </div>

  <script type="module">
    // Utilidades -----------------------------------------------------------
    const stateEmoji = new Map([
      ["Promocionado", "üü¢"],
      ["Pendiente", "üîµ"],
      ["Regular", "üü°"],
      ["Libre", "üî¥"],
      ["Cursando", "‚ö™Ô∏è"],
    ]);

    const norm = (s) => (s || "")
      .toString()
      .toLowerCase()
      .normalize('NFD')
      .replace(/\p{Diacritic}/gu, '')
      .replace(/[^a-z0-9 @._+\-]+/g, ' ')
      .trim();

    function initials(fullName) {
      if (!fullName) return "?";
      const [ap, nom] = fullName.split(",");
      const first = (nom || "").trim().split(/\s+/)[0] || "";
      const last = (ap || "").trim().split(/\s+/)[0] || "";
      return (first[0] || "") + (last[0] || "");
    }

    function colorFor(text) {
      let h = 0; for (let i = 0; i < text.length; i++) h = (h * 31 + text.charCodeAt(i)) >>> 0;
      h = h % 360; const s = 70, l = 50;
      return `linear-gradient(135deg, hsl(${h},${s}%,${l + 8}%) 0%, hsl(${(h + 30) % 360},${s - 10}%,${l - 6}%) 100%)`;
    }

    function githubAvatar(username) {
      if (!username) return null;
      const u = username.replace(/^@+/, '').trim();
      const github = `https://github.com/AlejandroDiBattista/{repo}/tree/main/TP/`
      if (!u) return null;
      return `https://github.com/${encodeURIComponent(u)}.png?size=120`;
    }

    // Precarga de im√°genes (avatares) -------------------------------------
    const imagePreloader = (() => {
      const preloaded = new Set();
      const queued = new Set();
      const inflight = new Set();
      const queue = [];
      let scheduled = null;
      let enabled = false;
      const maxConcurrency = 2;

      function schedule(mode = 'idle') {
        if (!enabled) return;
        if (scheduled) return;
        if ('requestIdleCallback' in window) {
          scheduled = window.requestIdleCallback(() => {
            scheduled = null;
            pump();
          });
          return;
        }
        scheduled = window.setTimeout(() => {
          scheduled = null;
          pump();
        }, mode === 'urgent' ? 250 : 500);
      }

      function preloadOne(url) {
        return new Promise((resolve) => {
          const img = new Image();
          img.decoding = 'async';
          img.loading = 'eager';
          img.referrerPolicy = 'no-referrer';
          if ('fetchPriority' in img) img.fetchPriority = 'low';
          img.onload = () => resolve(true);
          img.onerror = () => resolve(false);
          img.src = url;
        });
      }

      function pump() {
        if (!enabled) return;
        while (inflight.size < maxConcurrency && queue.length) {
          const url = queue.shift();
          queued.delete(url);
          if (!url || preloaded.has(url) || inflight.has(url)) continue;
          inflight.add(url);
          preloadOne(url).finally(() => {
            inflight.delete(url);
            preloaded.add(url);
            if (queue.length) schedule('idle');
          });
        }
      }

      function add(urls, mode = 'idle') {
        (urls || []).forEach(url => {
          if (!url || preloaded.has(url) || inflight.has(url) || queued.has(url)) return;
          queue.push(url);
          queued.add(url);
        });
        if (queue.length) schedule(mode);
      }

      function enable() {
        enabled = true;
        if (queue.length) schedule('idle');
      }

      function isEnabled() {
        return enabled;
      }

      return { add, enable, isEnabled };
    })();

    function canPreloadRemote() {
      const conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
      const saveData = !!conn?.saveData;
      const effectiveType = String(conn?.effectiveType || '').toLowerCase();
      const slow = effectiveType.includes('2g') || effectiveType.includes('slow');
      return !saveData && !slow;
    }

    function avatarUrlFor(a) {
      if (!a) return null;
      if (a.foto) return `./img/${a.legajo}.png`;
      return githubAvatar(a.github);
    }

    function primeAvatarPreload(list) {
      const urls = [];
      let remoteCount = 0;
      const allowRemote = canPreloadRemote();
      for (const a of (list || []).slice(0, 36)) {
        const url = avatarUrlFor(a);
        if (!url) continue;
        const isRemote = /^https?:\/\//i.test(url);
        if (isRemote) {
          if (!allowRemote) continue;
          if (remoteCount >= 12) continue;
          remoteCount += 1;
        }
        urls.push(url);
      }
      imagePreloader.add(urls, 'idle');
    }

    function warmLocalPhotos(all) {
      const urls = (all || []).filter(a => a?.foto).map(a => `./img/${a.legajo}.png`);
      imagePreloader.add(urls, 'idle');
    }

    let LAST_RENDERED = [];
    let primeIdleId = null;
    let primeTimeoutId = null;

    function schedulePrimeAvatarPreload() {
      if (!imagePreloader.isEnabled()) return;
      if ('cancelIdleCallback' in window && primeIdleId) {
        window.cancelIdleCallback(primeIdleId);
        primeIdleId = null;
      }
      if (primeTimeoutId) {
        window.clearTimeout(primeTimeoutId);
        primeTimeoutId = null;
      }

      if ('requestIdleCallback' in window) {
        primeIdleId = window.requestIdleCallback(() => {
          primeIdleId = null;
          primeAvatarPreload(LAST_RENDERED);
        });
        return;
      }
      primeTimeoutId = window.setTimeout(() => {
        primeTimeoutId = null;
        primeAvatarPreload(LAST_RENDERED);
      }, 600);
    }

    function enablePreloadingAfterLoad() {
      const run = () => {
        const enable = () => {
          imagePreloader.enable();
          schedulePrimeAvatarPreload();
        };
        if ('requestIdleCallback' in window) {
          window.requestIdleCallback(enable);
          return;
        }
        window.setTimeout(enable, 800);
      };
      if (document.readyState === 'complete') {
        run();
        return;
      }
      window.addEventListener('load', run, { once: true });
    }

    function githubTP(curso) {
      if (!curso || !curso.carpeta_tp) return null;
      const comision = curso.codigo.startsWith('L') ? `-${curso.comision}`.trim() : "";
      const repo = `TUP${Number(curso.a√±o) - 2000}-${curso.codigo}${comision}`;
      const carpeta = encodeURIComponent(curso.carpeta_tp);
      return `https://github.com/AlejandroDiBattista/${repo}/tree/main/TP/${carpeta}`;
    }

    // Overlay de zoom para avatares ------------------------------------
    const avatarZoom = (() => {
      const overlay = document.createElement('div');
      overlay.id = 'avatar-zoom';
      overlay.innerHTML = `<div class="zoom-frame"><img alt="Avatar ampliado" /></div>`;
      overlay.addEventListener('click', () => overlay.classList.remove('active'));
      document.body.appendChild(overlay);
      const img = overlay.querySelector('img');
      const show = (src, alt = 'Avatar') => {
        if (!src) return;
        img.src = src;
        img.alt = alt;
        overlay.classList.add('active');
      };
      window.addEventListener('keydown', (ev) => {
        if (ev.key === 'Escape') overlay.classList.remove('active');
      });
      return { show };
    })();

    // (Sin favoritos ni localStorage)

    // Render --------------------------------------------------------------
    function coursesForFacet(a, facets = facetState, searchText = baseSearchText) {
      let list = Array.isArray(a.cursos) ? a.cursos : [];
      const { year, materia, comision } = facets;
      if (year) list = list.filter(c => String(c.a√±o) === String(year));
      if (materia) list = list.filter(c => String(c.materia) === String(materia));
      if (comision) list = list.filter(c => String(c.comision) === String(comision));

      const abbrFilters = abbrevFiltersFromQuery(searchText);
      if (abbrFilters.length) {
        list = list.filter(c => abbrFilters.includes(materiaAbbreviation(c.materia).toUpperCase()));
      }
      const stateFilters = stateFiltersFromQuery(searchText);
      if (stateFilters.length) {
        list = list.filter(c => {
          const st = norm(c.estado || '');
          return stateFilters.every(sf => st.startsWith(sf));
        });
      }
      return list;
    }

    function cardTemplate(a) {
      const tel = a.telefono || '';
      const waNumber = tel.replace(/\D/g, '');
      const gh = githubAvatar(a.github);

      const em = s => stateEmoji.get(s) || '‚ö™Ô∏è';

      let perfil = '';
      if (a.foto) {
        perfil = `<div class="avatar"><img alt="avatar" src="./img/${a.legajo}.png" loading="lazy" decoding="async" fetchpriority="low" referrerpolicy="no-referrer"/></div>`;
      } else if (gh) {
        perfil = `<div class="avatar"><img alt="avatar" src="${gh}" loading="lazy" decoding="async" fetchpriority="low" referrerpolicy="no-referrer"/></div>`
      } else {
        perfil = `<div class="avatar" style="background:${colorFor(a.nombre || a.legajo)}"><span class="initials">${initials(a.nombre).toUpperCase()}</span></div>`;
      }
      const avatarHtml = perfil;
      const telefonoHtml = tel ? `<p class="meta"><b>Tel:</b> <a class="whatsapp-link" href="https://wa.me/${waNumber}" target="_blank" rel="noopener">${tel}</a></p>` : '';

      const practicos = (curso) => {
        let salida = '';
        for (const [key, value] of Object.entries(curso)) {
          if (key.startsWith('TP') && value) {
            salida += value + ' ';
          }
        }
        if (salida) {
          return `<div class="practicos">Pr√°cticos: ${salida}</div>`;
        } else {
          return '';
        }
      };

      const cursosFiltrados = coursesForFacet(a);
      const cursos = cursosFiltrados.map(c => {
        const repoUrl = githubTP(c);
        const link = repoUrl ? ` ¬∑ <a class="tp-link" href="${repoUrl}" target="_blank" rel="noopener">TP</a>` : '';
        return `
          <div class="course-line" style="flex-direction:column; align-items:flex-start;">
            <div><span class="emoji">${em(c.estado)}</span> <span>${c.a√±o} ¬∑ ${c.materia} ¬∑ ${c.comision} <small>${c.estado}</small>${link}</span></div>
            ${practicos(c)}
          </div>
        `;
      }).join('');
      const cursosHtml = cursos || `<div class="course-line muted">Sin cursos en esta faceta</div>`;
      return `
          <article class="card" data-legajo="${a.legajo}" tabindex="-1">
            ${avatarHtml}
            <div class="content">
              <h3 class="name" title="${(a.nombre || '').replace(/&/g, '&amp;').replace(/\"/g, '&quot;')}">${a.nombre || 'Sin nombre'}</h3>
              <p class="meta"><b>Legajo:</b> <span class="legajo-value" data-original-legajo="${a.legajo}">${a.legajo}</span></p>
              ${telefonoHtml}
            </div>
            <div class="courses">${cursosHtml}</div>
          </article>`;
    }

    // Navegaci√≥n por teclado (contactos) ---------------------------------
    let ACTIVE_LEGAJO = null;
    let ACTIVE_CARD = null;
    const COPY_FLASH = new WeakMap();
    const TYPEAHEAD_RESET_MS = 1000;
    let typeaheadBuffer = '';
    let typeaheadTimer = null;
    let typeaheadExpired = false;

    function isEditableTarget(el) {
      if (!(el instanceof Element)) return false;
      if (el.isContentEditable) return true;
      const tag = el.tagName?.toLowerCase();
      return tag === 'input' || tag === 'textarea' || tag === 'select';
    }

    function setActiveCard(card, { focus = false, scroll = false } = {}) {
      if (!card) return;
      if (!(card instanceof Element)) return;

      if (ACTIVE_CARD && ACTIVE_CARD !== card) {
        ACTIVE_CARD.classList.remove('kbd-selected');
        ACTIVE_CARD.tabIndex = -1;
        ACTIVE_CARD.removeAttribute('aria-selected');
        ACTIVE_CARD = null;
      }

      card.classList.add('kbd-selected');
      card.tabIndex = 0;
      card.setAttribute('aria-selected', 'true');
      ACTIVE_CARD = card;
      ACTIVE_LEGAJO = card.dataset.legajo || null;

      if (focus) {
        card.focus({ preventScroll: true });
      }
      if (scroll) {
        ensureCardVisible(card);
      }
    }

    function ensureCardVisible(card) {
      if (!card?.getBoundingClientRect) return;
      const rect = card.getBoundingClientRect();
      const header = document.querySelector('header');
      const footer = document.querySelector('.footer-note');
      const topOffset = (header?.offsetHeight || 0) + 20;
      const bottomOffset = (footer?.offsetHeight || 0) + 20;
      const usableBottom = window.innerHeight - bottomOffset;

      if (rect.top < topOffset) {
        const target = window.scrollY + rect.top - topOffset;
        window.scrollTo({ top: Math.max(target, 0), behavior: 'auto' });
        return;
      }

      const bottomOverflow = rect.bottom - usableBottom;
      if (bottomOverflow > 0) {
        const target = window.scrollY + bottomOverflow + 20;
        window.scrollTo({ top: target, behavior: 'auto' });
      }
    }

    function gridColumnCount(cards) {
      if (!cards.length) return 0;
      const top0 = cards[0].offsetTop;
      let cols = 0;
      for (const c of cards) {
        if (Math.abs(c.offsetTop - top0) <= 2) cols++;
        else break;
      }
      return Math.max(cols, 1);
    }

    function nextIndexFromArrow(key, index, cols, length) {
      if (index < 0 || index >= length) return index;
      if (!cols) return index;

      const row = Math.floor(index / cols);
      const col = index % cols;

      if (key === 'ArrowLeft') {
        return Math.max(index - 1, 0);
      }
      if (key === 'ArrowRight') {
        return Math.min(index + 1, length - 1);
      }
      if (key === 'ArrowUp') {
        if (row === 0) return index;
        return (row - 1) * cols + col;
      }
      if (key === 'ArrowDown') {
        const nextRowStart = (row + 1) * cols;
        if (nextRowStart >= length) return index;
        const nextRowLen = Math.min(cols, length - nextRowStart);
        return nextRowStart + Math.min(col, nextRowLen - 1);
      }
      return index;
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, (ch) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[ch]));
    }

    function normalizeChar(ch) {
      return ch.normalize('NFD').replace(/\p{Diacritic}/gu, '').toLowerCase();
    }

    function subsequencePositions(buffer, source) {
      const queryParts = normalizedQueryParts(buffer);
      if (!queryParts.length) return [];
      let qi = 0;
      const positions = [];
      for (let i = 0; i < source.length && qi < queryParts.length; i++) {
        const part = queryParts[qi];
        const nc = normalizeChar(source[i]);
        if (!nc.trim()) continue;
        if (nc === part.ch) {
          if (part.upper) {
            const prev = source[i - 1];
            const isWordStart = i === 0 || !/[\p{L}\p{N}]/u.test(prev || '');
            if (!isWordStart) continue;
          }
          positions.push(i);
          qi++;
        }
      }
      return qi === queryParts.length ? positions : [];
    }

    function clearTypeaheadHighlights() {
      contactsGrid.querySelectorAll('.card .name').forEach((el) => {
        const original = el.dataset.originalName || el.textContent || '';
        el.textContent = original;
      });
      contactsGrid.querySelectorAll('.card .legajo-value').forEach((el) => {
        const original = el.dataset.originalLegajo || el.textContent || '';
        el.textContent = original;
      });
    }

    function highlightMatch(card, buffer) {
      if (!card || !buffer) return;
      const nameEl = card.querySelector('.name');
      if (!nameEl) return;
      const original = nameEl.dataset.originalName || nameEl.textContent || '';
      const hits = subsequencePositions(buffer, original);
      if (!hits.length) {
        nameEl.textContent = original;
        return;
      }
      const hitSet = new Set(hits);
      let html = '';
      for (let i = 0; i < original.length; i++) {
        const ch = original[i];
        const safe = escapeHtml(ch);
        html += hitSet.has(i) ? `<span class="typeahead-hit">${safe}</span>` : safe;
      }
      nameEl.innerHTML = html;
    }

    function highlightLegajo(card, buffer) {
      if (!card || !buffer) return;
      const legajoEl = card.querySelector('.legajo-value');
      if (!legajoEl) return;
      const original = legajoEl.dataset.originalLegajo || legajoEl.textContent || '';
      const parts = normalizedQueryParts(buffer);
      const onlyDigits = parts.every(p => /\d/.test(p.ch));
      const hits = onlyDigits ? consecutivePositions(parts, original) : subsequencePositions(buffer, original);
      if (!hits.length) {
        legajoEl.textContent = original;
        return;
      }
      const hitSet = new Set(hits);
      let html = '';
      for (let i = 0; i < original.length; i++) {
        const ch = original[i];
        const safe = escapeHtml(ch);
        html += hitSet.has(i) ? `<span class="typeahead-hit">${safe}</span>` : safe;
      }
      legajoEl.innerHTML = html;
    }

    function resetTypeahead() {
      typeaheadExpired = true;
      if (typeaheadTimer) {
        window.clearTimeout(typeaheadTimer);
        typeaheadTimer = null;
      }
    }

    function scheduleTypeaheadReset() {
      if (typeaheadTimer) window.clearTimeout(typeaheadTimer);
      typeaheadTimer = window.setTimeout(resetTypeahead, TYPEAHEAD_RESET_MS);
    }

    function cardNameForSearch(card) {
      const legajo = card?.dataset?.legajo || '';
      const data = legajo ? ALL.find(a => String(a.legajo) === String(legajo)) : null;
      const raw = data?.nombre || card?.querySelector('.name')?.textContent || '';
      return (raw || '').replace(/,/g, ' ').trim();
    }

    function cardLegajoForSearch(card) {
      const fromDataset = card?.dataset?.legajo || '';
      if (fromDataset) return String(fromDataset);
      const legajoEl = card?.querySelector?.('.legajo-value');
      if (legajoEl) return legajoEl.textContent || '';
      return '';
    }

    function normalizedQueryParts(buffer) {
      const parts = [];
      for (const ch of buffer) {
        if (!ch.trim()) continue;
        const normalized = normalizeChar(ch);
        if (!normalized.trim()) continue;
        const isUpper = ch === ch.toUpperCase() && ch !== ch.toLowerCase();
        parts.push({ ch: normalized, upper: isUpper, raw: ch });
      }
      return parts;
    }

    function queryStringFromParts(parts) {
      return parts.map(p => p.ch).join('');
    }

    function consecutivePositions(query, source) {
      const q = queryStringFromParts(query);
      if (!q) return [];
      const target = String(source || '');
      const idx = target.indexOf(q);
      if (idx === -1) return [];
      return Array.from({ length: q.length }, (_, i) => idx + i);
    }

    function matchesPartsInText(parts, text) {
      let qi = 0;
      for (let i = 0; i < text.length && qi < parts.length; i++) {
        const part = parts[qi];
        const targetChar = text[i];
        const normTarget = normalizeChar(targetChar);
        if (!normTarget.trim()) continue;
        if (normTarget === part.ch) {
          if (part.upper) {
            const prev = text[i - 1];
            const isWordStart = i === 0 || !/[\p{L}\p{N}]/u.test(prev || '');
            if (!isWordStart) continue;
          }
          qi++;
        }
      }
      return qi === parts.length;
    }

    function matchesForBuffer(buffer) {
      const queryParts = normalizedQueryParts(buffer);
      if (!queryParts.length) return { cards: [], mode: null };
      const onlyDigits = queryParts.every(p => /\d/.test(p.ch));
      const mode = onlyDigits ? 'legajo' : 'name';
      const cards = [...contactsGrid.querySelectorAll('.card')];
      const matches = cards.filter(c => {
        const target = mode === 'legajo' ? cardLegajoForSearch(c) : cardNameForSearch(c);
        if (mode === 'legajo') {
          const normalizedTarget = String(target || '').replace(/\D+/g, '');
          const q = queryStringFromParts(queryParts);
          if (!q) return false;
          return normalizedTarget.includes(q);
        }
        return matchesPartsInText(queryParts, target);
      });
      return { cards: matches, mode };
    }

    function typeaheadMatch(buffer) {
      const { cards, mode } = matchesForBuffer(buffer);
      const first = cards[0] || null;
      return first ? { card: first, mode } : null;
    }

    function applyHighlights(buffer) {
      clearTypeaheadHighlights();
      const { cards: matches, mode } = matchesForBuffer(buffer);
      matches.forEach(card => {
        if (mode === 'legajo') highlightLegajo(card, buffer);
        else highlightMatch(card, buffer);
      });
    }

    function handleTypeahead(char) {
      if (typeaheadExpired) {
        typeaheadExpired = false;
        typeaheadBuffer = '';
        clearTypeaheadHighlights();
      }
      typeaheadBuffer += char;
      scheduleTypeaheadReset();
      const result = typeaheadMatch(typeaheadBuffer);
      if (result?.card) {
        setActiveCard(result.card, { focus: true, scroll: true });
        if (result.mode === 'legajo') {
          highlightLegajo(result.card, typeaheadBuffer);
        } else {
          highlightMatch(result.card, typeaheadBuffer);
        }
      }
      applyHighlights(typeaheadBuffer);
    }

    async function writeToClipboard(text) {
      if (!text) return false;
      try {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(text);
          return true;
        }
      } catch (err) {
        // fallback below
      }
      try {
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.setAttribute('readonly', '');
        ta.style.position = 'fixed';
        ta.style.top = '-9999px';
        ta.style.left = '-9999px';
        document.body.appendChild(ta);
        ta.select();
        const ok = document.execCommand('copy');
        document.body.removeChild(ta);
        return ok;
      } catch (err) {
        return false;
      }
    }

    function contactTextFromCard(card) {
      const legajo = card?.dataset?.legajo || '';
      const data = legajo ? ALL.find(a => String(a.legajo) === String(legajo)) : null;
      if (data) {
        const lines = [];
        lines.push(`${data.nombre || 'Sin nombre'} (${data.legajo || 'Sin legajo'})`);
        if ((data.telefono || '').trim()) lines.push(`Tel: ${data.telefono}`);
        if ((data.github || '').trim()) lines.push(`GitHub: ${data.github.replace(/^@+/, '')}`);
        const cursos = Array.isArray(data.cursos) ? data.cursos : [];
        if (cursos.length) {
          lines.push('Cursos:');
          cursos.forEach(c => {
            const a√±o = c.a√±o ?? '';
            const materia = c.materia ?? '';
            const comision = c.comision ?? '';
            const estado = c.estado ?? '';
            const parts = [a√±o, materia, comision].filter(Boolean).join(' ¬∑ ');
            const st = estado ? ` (${estado})` : '';
            if (parts) lines.push(`- ${parts}${st}`);
          });
        }
        return lines.join('\n');
      }

      const name = card?.querySelector?.('.name')?.textContent?.trim() || 'Sin nombre';
      const tel = card?.querySelector?.('.whatsapp-link')?.textContent?.trim() || '';
      const lines = [`${name}${legajo ? ` (${legajo})` : ''}`];
      if (tel) lines.push(`Tel: ${tel}`);
      return lines.join('\n');
    }

    function flashCopied(card) {
      if (!card) return;
      card.dataset.copied = 'true';
      const prev = COPY_FLASH.get(card);
      if (prev) window.clearTimeout(prev);
      const t = window.setTimeout(() => {
        if (card?.dataset) delete card.dataset.copied;
        COPY_FLASH.delete(card);
      }, 900);
      COPY_FLASH.set(card, t);
    }

    function zoomFromCard(card) {
      if (!card) return;
      const img = card.querySelector('.avatar img');
      if (!img?.src) return;
      avatarZoom.show(img.src, img.alt || 'Avatar');
    }

    function mountCards(container, list) {
      container.innerHTML = list.length ? list.map(cardTemplate).join('') : `<div class="empty">Sin resultados</div>`;
      // (Sin manejadores de favoritos)
      // Roving tabindex + selecci√≥n
      ACTIVE_CARD = null;
      const cards = [...container.querySelectorAll('.card')];
      cards.forEach(c => {
        c.tabIndex = -1;
        c.classList.remove('kbd-selected');
        c.removeAttribute('aria-selected');
        c.addEventListener('focus', () => setActiveCard(c));
        c.addEventListener('click', () => setActiveCard(c, { focus: true }));
        const nameEl = c.querySelector('.name');
        if (nameEl && !nameEl.dataset.originalName) {
          nameEl.dataset.originalName = nameEl.textContent || '';
        }
      });
      const preferred = ACTIVE_LEGAJO ? cards.find(c => c.dataset.legajo === ACTIVE_LEGAJO) : null;
      if (preferred) setActiveCard(preferred);
      else if (cards[0]) setActiveCard(cards[0]);

      // Fallback a iniciales si el avatar de GitHub falla
      container.querySelectorAll('.avatar img').forEach(img => {
        img.addEventListener('error', () => {
          const card = img.closest('.card');
          const name = card?.querySelector('.name')?.textContent || '';
          const wrapper = img.parentElement;
          if (wrapper) {
            wrapper.innerHTML = `<span class="initials">${initials(name).toUpperCase()}</span>`;
            wrapper.style.background = colorFor(name);
          }
        }, { once: true });

        img.addEventListener('click', (ev) => {
          ev.stopPropagation();
          avatarZoom.show(img.src, img.alt || 'Avatar');
        });
      });
    }

    function asArray(dict) { return Object.values(dict || {}); }

    const ABBREV_REGEX = /^(p|l)(\d+)$/i;
    const SPECIAL_QUERY_TOKENS = new Set(['f+', 'f-', 't+', 't-', 'g+', 'g-']);

    function flagFilterFromTokens(tokens, yes, no) {
      const hasYes = tokens.includes(yes);
      const hasNo = tokens.includes(no);
      if (hasYes && hasNo) return null;
      if (hasYes) return true;
      if (hasNo) return false;
      return null;
    }

    function photoFilterFromTokens(tokens) {
      return flagFilterFromTokens(tokens, 'f+', 'f-');
    }

    function phoneFilterFromTokens(tokens) {
      return flagFilterFromTokens(tokens, 't+', 't-');
    }

    function githubFilterFromTokens(tokens) {
      return flagFilterFromTokens(tokens, 'g+', 'g-');
    }

    function abbrevFiltersFromQuery(q) {
      return norm(q).split(/\s+/).filter(Boolean).filter(t => ABBREV_REGEX.test(t)).map(t => t.toUpperCase());
    }

    function materiaFromAbbr(abbr, year) {
      if (!abbr) return null;
      const upper = abbr.toUpperCase();
      const set = new Set();
      ALL.forEach(a => (a.cursos || []).forEach(c => {
        if (upper === materiaAbbreviation(c.materia).toUpperCase() && (!year || String(c.a√±o) === String(year))) {
          set.add(String(c.materia));
        }
      }));
      const list = [...set].sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
      return list[0] || null;
    }

    function comisionFromToken(token, year, materia) {
      if (!token || !materia) return null;
      const target = norm(token);
      const set = new Set();
      ALL.forEach(a => (a.cursos || []).forEach(c => {
        if (String(c.materia) === String(materia) && (!year || String(c.a√±o) === String(year))) {
          const comp = norm(String(c.comision || ''));
          if (comp && comp === target) set.add(String(c.comision));
        }
      }));
      const list = [...set].sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
      return list[0] || null;
    }

    const ESTADOS = ['libre', 'regular', 'promocionado', 'pendiente'];

    function expandSearchTokens(tokens) {
      const out = [];
      for (const t of tokens) {
        if (!t) continue;
        const m = t.match(ABBREV_REGEX);
        if (m) {
          const full = (m[1].toLowerCase() === 'p' ? 'programacion' : 'laboratorio') + ' ' + m[2];
          norm(full).split(/\s+/).filter(Boolean).forEach(part => out.push(part));
        } else {
          out.push(t);
        }
      }
      return out;
    }

    function stateFiltersFromQuery(q) {
      const toks = norm(q).split(/\s+/).filter(Boolean);
      return toks.filter(t => ESTADOS.some(e => e.startsWith(t)));
    }

    function materiaAbbreviation(name) {
      const normalized = norm(name);
      const regexMatch = normalized.match(/^(programacion|laboratorio)[a-z\s]*?(\d+)/);
      if (regexMatch) {
        const prefix = regexMatch[1] === 'programacion' ? 'P' : 'L';
        return `${prefix}${regexMatch[2]}`;
      }
      const m = normalized.match(/^(p|l)(\d+)/);
      if (m) {
        return m[0].toUpperCase();
      }
      return name;
    }

    function yearsForMateria(materia) {
      if (!materia) return [];
      const set = new Set();
      ALL.forEach(a => (a.cursos || []).forEach(c => {
        if (String(c.materia) === String(materia)) set.add(String(c.a√±o));
      }));
      return [...set].filter(Boolean).sort((a, b) => a.localeCompare(b, 'es', { numeric: true }));
    }

    function filterItems(items, q, facets = facetState) {
      const normalizedTokens = norm(q || '').split(/\s+/).filter(Boolean);
      const abbrFilters = abbrevFiltersFromQuery(q);
      const stateFilters = stateFiltersFromQuery(q);
      const photoFilter = photoFilterFromTokens(normalizedTokens);
      const phoneFilter = phoneFilterFromTokens(normalizedTokens);
      const githubFilter = githubFilterFromTokens(normalizedTokens);
      const palabras = expandSearchTokens(normalizedTokens.filter(t => !SPECIAL_QUERY_TOKENS.has(t)));
      return items.filter(a => {
        const cursos = (a.cursos || []).flatMap(c => [c.materia, c.comision, c.estado, String(c.a√±o), c.codigo]);
        const base = [a.nombre, a.telefono || '', a.legajo || '', a.github || '', `${a.cursos.length}x`];
        const texto = norm(base.concat(cursos).filter(Boolean).join(' '));
        const tokens = texto.split(/\s+/).filter(Boolean);
        const hay = palabras.every(p => tokens.some(t => t.startsWith(p)));
        if (!hay) return false;
        if (photoFilter === true  && !a.foto) return false;
        if (photoFilter === false &&  a.foto) return false;
        const hasPhone = Boolean((a.telefono || '').trim());
        if (phoneFilter === true  && !hasPhone) return false;
        if (phoneFilter === false &&  hasPhone) return false;
        const hasGithub = Boolean((a.github || '').trim());
        if (githubFilter === true  && !hasGithub) return false;
        if (githubFilter === false &&  hasGithub) return false;
        if (abbrFilters.length) {
          const tieneAbbr = abbrFilters.every(abbr =>
            (a.cursos || []).some(c => materiaAbbreviation(c.materia).toUpperCase() === abbr)
          );
          if (!tieneAbbr) return false;
        }
        if (stateFilters.length) {
          const tieneEstado = stateFilters.every(sf =>
            (a.cursos || []).some(c => norm(c.estado || '').startsWith(sf))
          );
          if (!tieneEstado) return false;
        }
        // Si hay filtros de faceta/abreviatura/estado, el alumno debe tener cursos que cumplan todos
        const facetApplied = facets.year || facets.materia || facets.comision || abbrFilters.length || stateFilters.length;
        if (facetApplied) {
          const courses = coursesForFacet(a, facets, q);
          if (!courses.length) return false;
        }
        return hay;
      });
    }

    function sortByNombre(items) {
      return [...items].sort((a, b) => (a.nombre || '').localeCompare(b.nombre || '', 'es', { sensitivity: 'base' }));
    }

    let ALL = [];
    let DATA_LOADED = false;
    let DATA_PROMISE = null;
    let baseSearchText = '';
    let LAST_FILTERED = [];

    function render() {
      const filtered = sortByNombre(filterItems(ALL, baseSearchText, facetState));
      mountCards(document.getElementById('contacts'), filtered);
      document.getElementById('all-count').textContent = `(${filtered.length})`;
      LAST_RENDERED = filtered;
      LAST_FILTERED = filtered;
      schedulePrimeAvatarPreload();
    }

    const applySearch = () => render();
    let searchRenderId = null;
    function scheduleSearchRender() {
      if (searchRenderId) {
        cancelAnimationFrame(searchRenderId);
      }
      searchRenderId = requestAnimationFrame(() => {
        searchRenderId = null;
        applySearch();
      });
    }

    // Carga √∫nica de datos -----------------------------------------------
    function ensureDataLoaded() {
      if (DATA_LOADED) return Promise.resolve(ALL);
      if (!DATA_PROMISE) {
        const contacts = document.getElementById('contacts');
        contacts.innerHTML = '<div class="empty">Cargando datos...</div>';
        DATA_PROMISE = (async () => {
          const resp = await fetch('./alumnos.json', { cache: 'no-store' });
          if (!resp.ok) throw new Error('HTTP ' + resp.status);
          const data = await resp.json();
          ALL = asArray(data).map(a => ({
            legajo: String(a.legajo || '').trim(),
            nombre: a.nombre || '',
            telefono: a.telefono || '',
            github: a.github || '',
            foto: a.foto || false,
            cursos: Array.isArray(a.cursos) ? a.cursos : [],
          }));
          DATA_LOADED = true;
          return ALL;
        })().catch(err => {
          console.error('Error al cargar alumnos (fetch)', err);
          const container = document.getElementById('contacts');
          container.innerHTML = '<div class="empty">No se pudo cargar alumnos.json</div>';
          throw err;
        });
      }
      return DATA_PROMISE;
    }

    const searchInput = document.getElementById('search');
    const facetState = { year: null, materia: null, comision: null };
    const facetContainers = {
      years: document.getElementById('facet-years'),
      materias: document.getElementById('facet-materias'),
      comisiones: document.getElementById('facet-comisiones'),
    };
    const facetSeparators = {
      yToM: document.getElementById('facet-sep-1'),
      mToC: document.getElementById('facet-sep-2'),
    };
    function combinedSearchText() {
      const facetPart = facetQueryString();
      return [baseSearchText, facetPart].filter(Boolean).join(' ').trim();
    }

    function refreshSearchDisplay() {
      const combined = combinedSearchText();
      if (searchInput.value !== combined) searchInput.value = combined;
    }

    // Atajos globales ------------------------------------------------------
    document.addEventListener('keydown', (ev) => {
      const key = (ev.key || '').toLowerCase();
      const isMod = ev.ctrlKey || ev.metaKey;
      if (isMod && key === 'k') {
        ev.preventDefault();
        searchInput.focus();
        searchInput.select();
      }
    });

    // Navegaci√≥n en grilla de contactos -----------------------------------
    const contactsGrid = document.getElementById('contacts');
    contactsGrid.addEventListener('keydown', (ev) => {
      const card = ev.target?.closest?.('.card');
      if (!card || !contactsGrid.contains(card)) return;
      if (isEditableTarget(ev.target)) return;

      const key = ev.key || '';
      const lower = key.toLowerCase();
      const isMod = ev.ctrlKey || ev.metaKey;

      if (isMod && lower === 'c') {
        const selectedText = (window.getSelection?.()?.toString?.() || '').trim();
        if (selectedText) return;
        ev.preventDefault();
        const text = contactTextFromCard(card);
        writeToClipboard(text).then((ok) => {
          if (ok) flashCopied(card);
        });
        return;
      }

      if (key === ' ' || key === 'Spacebar') {
        ev.preventDefault();
        zoomFromCard(card);
        return;
      }

      const isCharKey = key.length === 1 && !isMod && !ev.altKey && key.trim() !== '';
      if (isCharKey) {
        ev.preventDefault();
        handleTypeahead(key);
        return;
      }

      if (key === 'Tab') {
        const cards = [...contactsGrid.querySelectorAll('.card')];
        const index = cards.indexOf(card);
        if (index < 0) return;
        const buffer = typeaheadBuffer.trim();
        if (buffer) {
          const { cards: matches, mode } = matchesForBuffer(buffer);
          if (matches.length) {
            ev.preventDefault();
            const cur = matches.indexOf(card);
            let nextCard = null;
            if (ev.shiftKey) {
              nextCard = matches[cur > 0 ? cur - 1 : matches.length - 1];
            } else {
              nextCard = matches[cur >= 0 ? (cur + 1) % matches.length : 0];
            }
            setActiveCard(nextCard, { focus: true, scroll: true });
            applyHighlights(buffer);
            return;
          }
        }
        if (ev.shiftKey) {
          if (index === 0) return;
          ev.preventDefault();
          setActiveCard(cards[index - 1], { focus: true, scroll: true });
          return;
        }
        if (index >= cards.length - 1) return;
        ev.preventDefault();
        setActiveCard(cards[index + 1], { focus: true, scroll: true });
        return;
      }

      if (key === 'ArrowLeft' || key === 'ArrowRight' || key === 'ArrowUp' || key === 'ArrowDown') {
        ev.preventDefault();
        const cards = [...contactsGrid.querySelectorAll('.card')];
        const index = cards.indexOf(card);
        if (index < 0) return;
        const cols = gridColumnCount(cards);
        const next = nextIndexFromArrow(key, index, cols, cards.length);
        if (next === index) return;
        setActiveCard(cards[next], { focus: true, scroll: true });
      }
    });

    function facetQueryString() {
      const materiaToken = facetState.materia ? materiaAbbreviation(facetState.materia) : null;
      return [facetState.year, materiaToken, facetState.comision].filter(Boolean).join(' ');
    }

    function validYearToken(t) {
      if (!/^\d{4}$/.test(t)) return false;
      const years = getYears();
      return years.includes(String(t));
    }

    function syncFacetsFromQuery(q) {
      if (!DATA_LOADED) return;
      const tokens = norm(q).split(/\s+/).filter(Boolean);
      const yearToken = tokens.find(validYearToken) || null;
      const abbrTokenRaw = tokens.find(t => ABBREV_REGEX.test(t)) || null;
      const abbrToken = abbrTokenRaw ? abbrTokenRaw.toUpperCase() : null;
      const comToken = tokens.find(t => /^c[\w-]+$/i.test(t)) || null;

      const materiaToken = abbrToken ? materiaFromAbbr(abbrToken, yearToken) : null;
      let resolvedYear = yearToken;
      if (!resolvedYear && materiaToken) {
        const years = yearsForMateria(materiaToken);
        if (years.length === 1) {
          resolvedYear = years[0];
        } else if (years.length > 1) {
          resolvedYear = years[years.length - 1]; // toma el a√±o m√°s reciente
        }
      }
      const comisionToken = comToken ? comisionFromToken(comToken, resolvedYear, materiaToken) : null;

      facetState.year = resolvedYear;
      facetState.materia = materiaToken;
      facetState.comision = comisionToken;
      renderFacets();
    }

    function getYears(list) {
      const set = new Set();
      list.forEach(a => (a.cursos || []).forEach(c => {
        if (c.a√±o !== undefined && c.a√±o !== null && c.a√±o !== '') {
          set.add(String(c.a√±o));
        }
      }));
      return [...set].sort((a, b) => a.localeCompare(b, 'es', { numeric: true }));
    }

    function getMaterias(year, list) {
      if (!year) return [];
      const set = new Set();
      list.forEach(a => (a.cursos || []).forEach(c => {
        if (String(c.a√±o) === String(year) && c.materia) set.add(String(c.materia));
      }));
      return [...set].sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
    }

    function getComisiones(year, materia, list) {
      if (!year || !materia) return [];
      const set = new Set();
      list.forEach(a => (a.cursos || []).forEach(c => {
        if (String(c.a√±o) === String(year) && String(c.materia) === String(materia) && c.comision) {
          set.add(String(c.comision));
        }
      }));
      return [...set].sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
    }

    function countYears(list) {
      const out = {};
      list.forEach(a => {
        const years = new Set();
        (a.cursos || []).forEach(c => {
          if (c.a√±o !== undefined && c.a√±o !== null && c.a√±o !== '') {
            years.add(String(c.a√±o));
          }
        });
        years.forEach(y => { out[y] = (out[y] || 0) + 1; });
      });
      return out;
    }

    function countMaterias(list, year) {
      const out = {};
      list.forEach(a => {
        const materias = new Set();
        (a.cursos || []).forEach(c => {
          if (String(c.a√±o) === String(year) && c.materia) {
            materias.add(String(c.materia));
          }
        });
        materias.forEach(m => { out[m] = (out[m] || 0) + 1; });
      });
      return out;
    }

    function countComisiones(list, year, materia) {
      const out = {};
      list.forEach(a => {
        const comisiones = new Set();
        (a.cursos || []).forEach(c => {
          if (String(c.a√±o) === String(year) && String(c.materia) === String(materia) && c.comision) {
            comisiones.add(String(c.comision));
          }
        });
        comisiones.forEach(c => { out[c] = (out[c] || 0) + 1; });
      });
      return out;
    }

    function renderFacetLinks(container, values, activeValue, onClick, counts = null) {
      container.innerHTML = '';
      if (!values.length) return;
      values.forEach(val => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'facet-pill' + (activeValue === val ? ' active' : '');
        const count = counts ? counts[val] || 0 : 0;
        btn.innerHTML = count ? `${val} <span class="facet-count">(${count})</span>` : val;
        btn.addEventListener('click', () => onClick(val));
        container.appendChild(btn);
      });
    }

    function renderFacets() {
      if (!DATA_LOADED) return;
      facetSeparators.yToM.style.display = 'none';
      facetSeparators.mToC.style.display = 'none';
      const baseForYears = facetState.year
        ? filterItems(ALL, baseSearchText, { year: facetState.year, materia: null, comision: null })
        : filterItems(ALL, baseSearchText, { year: null, materia: null, comision: null });
      const yearCounts = countYears(baseForYears);
      const years = Object.keys(yearCounts).sort((a, b) => a.localeCompare(b, 'es', { numeric: true }));
      const yearsToShow = facetState.year ? [facetState.year] : years;
      renderFacetLinks(facetContainers.years, yearsToShow, facetState.year, toggleYear, yearCounts);

      if (!facetState.year) {
        facetContainers.materias.innerHTML = '';
        facetContainers.comisiones.innerHTML = '';
        return;
      }
      facetSeparators.yToM.style.display = 'inline-block';

      const materiaFiltered = filterItems(ALL, baseSearchText, { year: facetState.year, materia: null, comision: null });
      const materiaCounts = countMaterias(materiaFiltered, facetState.year);
      const materias = getMaterias(facetState.year, materiaFiltered);
      const materiasToShow = facetState.materia ? [facetState.materia] : materias;
      renderFacetLinks(facetContainers.materias, materiasToShow, facetState.materia, toggleMateria, materiaCounts);

      if (!facetState.materia) {
        facetContainers.comisiones.innerHTML = '';
        return;
      }
      facetSeparators.mToC.style.display = 'inline-block';

      const comisionFiltered = filterItems(ALL, baseSearchText, { year: facetState.year, materia: facetState.materia, comision: null });
      const comisionCounts = countComisiones(comisionFiltered, facetState.year, facetState.materia);
      const comisiones = getComisiones(facetState.year, facetState.materia, comisionFiltered);
      const comisionesToShow = facetState.comision ? [facetState.comision] : comisiones;
      renderFacetLinks(facetContainers.comisiones, comisionesToShow, facetState.comision, toggleComision, comisionCounts);
    }

    function syncFacetsToSearch() {
      refreshSearchDisplay();
      setSearchParam(baseSearchText);
      if (DATA_LOADED) render();
    }

    function toggleYear(year) {
      if (facetState.year === year) {
        facetState.year = null;
        facetState.materia = null;
        facetState.comision = null;
      } else {
        facetState.year = year;
        facetState.materia = null;
        facetState.comision = null;
      }
      syncFacetsToSearch();
      renderFacets();
    }

    function toggleMateria(materia) {
      if (!facetState.year) return;
      if (facetState.materia === materia) {
        facetState.materia = null;
        facetState.comision = null;
      } else {
        facetState.materia = materia;
        facetState.comision = null;
      }
      syncFacetsToSearch();
      renderFacets();
    }

    function toggleComision(comision) {
      if (!facetState.year || !facetState.materia) return;
      if (facetState.comision === comision) {
        facetState.comision = null;
      } else {
        facetState.comision = comision;
      }
      syncFacetsToSearch();
      renderFacets();
    }

    function setSearchParam(q) {
      const url = new URL(window.location.href);
      if (q) {
        url.searchParams.set('q', q);
      } else {
        url.searchParams.delete('q');
      }
      window.history.replaceState({}, '', url);
    }

    function syncInputFromURL() {
      const url = new URL(window.location.href);
      const q = url.searchParams.get('q') || '';
      baseSearchText = q;
      refreshSearchDisplay();
      return q;
    }

    searchInput.addEventListener('input', () => {
      const facetPart = facetQueryString();
      const raw = searchInput.value;
      if (facetPart && raw.toLowerCase().trim().endsWith(facetPart.toLowerCase())) {
        baseSearchText = raw.slice(0, raw.length - facetPart.length).trim();
      } else {
        baseSearchText = raw;
      }
      setSearchParam(baseSearchText);
      refreshSearchDisplay();
      if (!DATA_LOADED) {
        // Evita intentar filtrar sin datos; la promesa actualizar√° despu√©s
        return;
      }
      syncFacetsFromQuery(baseSearchText);
      renderFacets();
      scheduleSearchRender();
    });

    searchInput.addEventListener('keydown', (ev) => {
      if (ev.key !== 'ArrowDown') return;
      ev.preventDefault();

      const focusFirstCard = () => {
        const grid = document.getElementById('contacts');
        const card = ACTIVE_CARD || grid.querySelector('.card[tabindex="0"]') || grid.querySelector('.card');
        if (!card) return;
        setActiveCard(card, { focus: true, scroll: true });
      };

      const afterRender = () => window.requestAnimationFrame(focusFirstCard);

      if (DATA_LOADED) {
        afterRender();
        return;
      }

      ensureDataLoaded().then(() => {
        syncFacetsFromQuery(baseSearchText);
        renderFacets();
        render();
        afterRender();
      });
    });

    window.addEventListener('popstate', () => {
      const q = syncInputFromURL();
      if (DATA_LOADED) {
        syncFacetsFromQuery(baseSearchText);
        refreshSearchDisplay();
        render();
      } else {
        ensureDataLoaded().then(() => {
          syncFacetsFromQuery(baseSearchText);
          refreshSearchDisplay();
          render();
        });
      }
    });

    function start() {
      const q = syncInputFromURL();
      ensureDataLoaded().then(() => {
        syncFacetsFromQuery(baseSearchText);
        renderFacets();
        refreshSearchDisplay();
        render();
      });
    }
    if (document.readyState === 'loading') {
      window.addEventListener('DOMContentLoaded', start, { once: true });
    } else {
      start();
    }

    enablePreloadingAfterLoad();
  </script>

</body>

</html>
