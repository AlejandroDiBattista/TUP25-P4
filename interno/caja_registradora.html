<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Caja Registradora</title>
  <style>
    :root {
      --bg: #0f172a;
      --card: #111827;
      --accent: #06b6d4;
      --muted: #94a3b8;
      --border: #1f2937;
      --radius: 14px;
      --shadow: 0 10px 40px rgba(0, 0, 0, 0.45);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 16px;
      font-family: "Space Grotesk", "Segoe UI", system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(6, 182, 212, 0.15), transparent 35%), radial-gradient(circle at 80% 10%, rgba(244, 63, 94, 0.12), transparent 30%), var(--bg);
      color: #e2e8f0;
    }
    h1 { margin: 0 0 8px; letter-spacing: -0.03em; }
    p { margin: 0 0 12px; color: #cbd5e1; }
    .shell { max-width: 1040px; margin: 0 auto; display: grid; gap: 16px; }
    .panel {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 9999px;
      background: rgba(6, 182, 212, 0.12);
      color: #67e8f9;
      border: 1px solid rgba(6, 182, 212, 0.35);
      font-weight: 700;
      font-size: 13px;
    }
    .scanner-box {
      height: 150px;
      width: 100%;
      background: linear-gradient(135deg, rgba(6, 182, 212, 0.15), rgba(14, 165, 233, 0.05));
      border: 1px dashed rgba(226, 232, 240, 0.35);
      border-radius: 14px;
      overflow: hidden;
      position: relative;
    }
    video { width: 100%; height: 100%; object-fit: cover; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 960px) { .grid { grid-template-columns: 1.2fr 0.8fr; align-items: start; } }
    .input {
      width: 100%;
      padding: 12px 14px;
      background: #0b1221;
      border: 1px solid var(--border);
      border-radius: 10px;
      color: #e2e8f0;
      font-size: 15px;
    }
    .input:focus { outline: 2px solid rgba(6, 182, 212, 0.4); }
    .btn {
      border: none;
      border-radius: 10px;
      padding: 12px 16px;
      background: var(--accent);
      color: #0b1221;
      font-weight: 700;
      cursor: pointer;
      transition: transform 120ms ease, box-shadow 120ms ease;
      box-shadow: 0 10px 25px rgba(6, 182, 212, 0.32);
      white-space: nowrap;
    }
    .btn.secondary { background: #1e293b; color: #e2e8f0; box-shadow: none; border: 1px solid var(--border); }
    .btn:active { transform: translateY(1px); }
    .list { display: grid; gap: 10px; margin-top: 12px; }
    .item {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      padding: 12px;
      background: #0b1221;
      border: 1px solid var(--border);
      border-radius: 12px;
    }
    .item img {
      width: 56px;
      height: 56px;
      object-fit: cover;
      border-radius: 10px;
      background: #020617;
      border: 1px solid var(--border);
    }
    .muted { color: var(--muted); font-size: 13px; }
    .pill {
      padding: 6px 10px;
      border-radius: 9999px;
      background: rgba(34, 197, 94, 0.15);
      color: #bbf7d0;
      font-weight: 700;
      border: 1px solid rgba(34, 197, 94, 0.35);
      font-size: 13px;
    }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .cart-summary { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; padding-top: 10px; border-top: 1px dashed var(--border); }
    .toast {
      position: fixed;
      left: 50%;
      bottom: 14px;
      transform: translateX(-50%);
      background: rgba(15, 23, 42, 0.92);
      color: #e2e8f0;
      padding: 10px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      font-size: 14px;
      z-index: 50;
      min-width: 200px;
      text-align: center;
    }
  </style>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin></script>
  <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
  <script src="./vendor-html5-qrcode.min.js"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel" data-presets="env,react">
    const { useEffect, useRef, useState, useMemo, useCallback } = React;

    const STORAGE_KEY = "caja-carrito";
    const THROTTLE_MS = 5000;

    const PRODUCT_DATA = [
      {"productId":"22668","productName":"Gaseosa Dual Pack Coca Cola+Sprite 2.25L","productTitle":"Gaseosa Dual Pack Coca Cola+Sprite 2.25L","ean":"7790895006890","price":6136.0,"imageUrl":"https://alberdisa.vteximg.com.br/arquivos/ids/181362/Foto-Producto.png.png?v=638818741668970000"},
      {"productId":"22799","productName":"Gaseosa Coca Cola Lata 354Cc","productTitle":"Gaseosa Coca Cola Lata 354Cc","ean":"7790895000232","price":1560.0,"imageUrl":"https://alberdisa.vteximg.com.br/arquivos/ids/181168/Foto-Producto.png.png?v=638785268822970000"},
      {"productId":"7043","productName":"Gaseosa Pepsi   x 3000 Cc","productTitle":"Gaseosa Pepsi   x 3000 Cc","ean":"7791813555063","price":3387.29,"imageUrl":"https://alberdisa.vteximg.com.br/arquivos/ids/174012/Gaseosa-Pepsi---x-3000-Cc.png?v=638146553631130000"},
      {"productId":"13991","productName":"Gaseosa Coca Cola Promo 6x5 375 Cc","productTitle":"Gaseosa Coca Cola Promo 6x5 375 Cc","ean":"7790895008085","price":6749.6,"imageUrl":"https://alberdisa.vteximg.com.br/arquivos/ids/182083/coca-cola_six_pack_375cc.png?v=638937950276700000"},
      {"productId":"6015","productName":"Gaseosa Coca Cola Sin Azucar 1500 Cc","productTitle":"Gaseosa Coca Cola Sin Azucar 1500 Cc","ean":"7790895067556","price":3120.0,"imageUrl":"https://alberdisa.vteximg.com.br/arquivos/ids/177188/45388.png?v=638453604730300000"},
      {"productId":"1955","productName":"Gaseosa Coca Cola Sin Azucar 500 Cc","productTitle":"Gaseosa Coca Cola Sin Azucar 500 Cc","ean":"7790895067532","price":1560.0,"imageUrl":"https://alberdisa.vteximg.com.br/arquivos/ids/181842/COCA_cola_sin_azucar_500ml.png?v=638908657543970000"},
      {"productId":"644","productName":"Gaseosa Coca Cola  x 2250 Cc","productTitle":"Gaseosa Coca Cola  x 2250 Cc","ean":"7790895000997","price":4368.0,"imageUrl":"https://alberdisa.vteximg.com.br/arquivos/ids/177182/4593.png?v=638453544458630000"},
      {"productId":"21697","productName":"Gaseosa Fanta Limon Dulce 2500 Cc","productTitle":"Gaseosa Fanta Limon Dulce 2500 Cc","ean":"7790895648366","price":2600.0,"imageUrl":"https://alberdisa.vteximg.com.br/arquivos/ids/179722/fan.png?v=638618383883700000"},
      {"productId":"6230","productName":"Gaseosa Coca Cola Sin Azucar 2250 Cc","productTitle":"Gaseosa Coca Cola Sin Azucar 2250 Cc","ean":"7790895067570","price":4368.0,"imageUrl":"https://alberdisa.vteximg.com.br/arquivos/ids/177189/51935.png?v=638453615670300000"},
      {"productId":"3840","productName":"Gaseosa Pepsi x 354 Cc","productTitle":"Gaseosa Pepsi x 354 Cc","ean":"7791813555025","price":1245.99,"imageUrl":"https://alberdisa.vteximg.com.br/arquivos/ids/174050/Gaseosa-Pepsi-x-354-Cc.png?v=638146568606170000"}
    ];

    const money = (n) => new Intl.NumberFormat("es-AR", { style: "currency", currency: "ARS" }).format(n);

    const loadCarrito = () => {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch (e) {
        return [];
      }
    };
    const saveCarrito = (items) => localStorage.setItem(STORAGE_KEY, JSON.stringify(items));

    const useProductos = () => ({ productos: PRODUCT_DATA, loading: false, error: null });

    function BarcodeScanner({ onEan }) {
      const videoRef = useRef(null);
      const lastScanRef = useRef(0);
      const [status, setStatus] = useState("init");
      const [mode, setMode] = useState(("BarcodeDetector" in window) ? "native" : "html5");
      const html5IdRef = useRef(`html5qr-${Math.random().toString(36).slice(2)}`);
      const html5InstanceRef = useRef(null);

      const ensureHtml5Lib = useCallback(() => {
        if (window.Html5Qrcode) return Promise.resolve(true);
        return Promise.reject(new Error("html5-qrcode no está disponible"));
      }, []);

      useEffect(() => {
        let stream; let detector; let rafId; let cancelled = false;

        const handleDetection = (ean) => {
          const now = Date.now();
          if (ean && now - lastScanRef.current >= THROTTLE_MS) {
            lastScanRef.current = now;
            onEan(ean);
          }
        };

        const setupNative = async () => {
          try { detector = new BarcodeDetector({ formats: ["ean_13", "ean_8", "code_128", "code_39"] }); }
          catch { return false; }
          try {
            stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            if (videoRef.current) {
              videoRef.current.srcObject = stream;
              await videoRef.current.play();
              setStatus("active");
              tickNative();
              return true;
            }
          } catch (err) {
            setStatus(err.name === "NotAllowedError" ? "blocked" : "error");
            return false;
          }
          return false;
        };

        const tickNative = async () => {
          if (!videoRef.current || videoRef.current.readyState < 2) { rafId = requestAnimationFrame(tickNative); return; }
          try {
            const codes = await detector.detect(videoRef.current);
            if (codes && codes.length > 0) handleDetection(codes[0].rawValue);
          } catch (err) { console.error("Detector error", err); }
          rafId = requestAnimationFrame(tickNative);
        };

        const setupHtml5 = async () => {
          setStatus("loading");
          try {
            await ensureHtml5Lib();
          } catch (e) {
            setStatus("unsupported");
            return false;
          }
          try {
            const cameras = await window.Html5Qrcode.getCameras();
            if (!cameras || !cameras.length) { setStatus("error"); return false; }
            const camId = cameras.find((c) => c.label.toLowerCase().includes("back"))?.id || cameras[0].id;
            const formatEnum = window.Html5QrcodeSupportedFormats || {};
            const formats = [
              formatEnum.EAN_13,
              formatEnum.EAN_8,
              formatEnum.CODE_128,
              formatEnum.CODE_39
            ].filter(Boolean);
            html5InstanceRef.current = new Html5Qrcode(html5IdRef.current, { formatsToSupport: formats.length ? formats : undefined });
            await html5InstanceRef.current.start(
              camId,
              { fps: 10, qrbox: { width: 240, height: 120 } },
              (decodedText) => handleDetection(decodedText),
              () => {}
            );
            if (!cancelled) setStatus("active");
            return true;
          } catch (err) {
            console.error("html5-qrcode error", err);
            setStatus(err?.name === "NotAllowedError" ? "blocked" : "error");
            return false;
          }
        };

        const hasNative = "BarcodeDetector" in window;
        setMode(hasNative ? "native" : "html5");
        setStatus("init");
        const tryNative = async () => {
          const ok = hasNative ? await setupNative() : false;
          if (!ok) {
            setMode("html5");
            await setupHtml5();
          }
        };
        tryNative();

        return () => {
          cancelled = true;
          if (rafId) cancelAnimationFrame(rafId);
          if (stream) stream.getTracks().forEach((t) => t.stop());
          if (html5InstanceRef.current) {
            html5InstanceRef.current.stop().catch(() => {});
            html5InstanceRef.current.clear().catch(() => {});
          }
        };
      }, [onEan]);

      const statusLabel = {
        init: "Inicializando cámara…",
        loading: "Cargando escáner…",
        active: "Escanea un código EAN. Espera 5s entre lecturas.",
        unsupported: "Escáner no soportado en este navegador.",
        blocked: "Permite el acceso a la cámara.",
        error: "No se pudo iniciar la cámara."
      }[status];

      return (
        <div className="panel">
          <div className="row" style={{ justifyContent: "space-between" }}>
            <div className="badge">Escáner EAN</div>
            <small>Intervalo mínimo: 5s</small>
          </div>
          <div className="scanner-box" style={{ marginTop: 12 }}>
            {mode === "native" ? <video ref={videoRef} autoPlay playsInline muted /> : <div id={html5IdRef.current} style={{ width: "100%", height: "100%" }} />}
          </div>
          <small>{statusLabel}</small>
        </div>
      );
    }

    function Buscador({ query, setQuery, onAddEan }) {
      return (
        <div className="panel">
          <div className="badge">Buscar / Ingresar EAN</div>
          <div className="row" style={{ marginTop: 10 }}>
            <input className="input" style={{ flex: 1, minWidth: 0 }} placeholder="Descripción o código EAN" value={query} onChange={(e) => setQuery(e.target.value)} />
            <button className="btn" onClick={onAddEan}>Agregar EAN</button>
          </div>
          <small>Un solo campo para buscar o agregar EAN. El escáner llena este campo automáticamente.</small>
        </div>
      );
    }

    function ListaProductos({ items, onAdd }) {
      return (
        <div className="panel">
          <div className="row" style={{ justifyContent: "space-between", alignItems: "center" }}>
            <div className="badge">Resultados</div>
            <small>{items.length} mostrados (máx 5)</small>
          </div>
          <div className="list">
            {items.map((p) => (
              <div className="item" key={p.productId}>
                <div>
                  <div className="row" style={{ alignItems: "center" }}>
                    <img src={p.imageUrl} alt={p.productTitle} />
                    <div>
                      <div>{p.productTitle}</div>
                      <div className="muted">EAN: {p.ean}</div>
                    </div>
                  </div>
                </div>
                <div style={{ display: "grid", gap: 6, justifyItems: "end" }}>
                  <div className="pill">{money(p.price)}</div>
                  <button className="btn secondary" onClick={() => onAdd(p)}>Agregar</button>
                </div>
              </div>
            ))}
            {items.length === 0 && <div className="muted">Sin coincidencias.</div>}
          </div>
        </div>
      );
    }

    function Carrito({ items, productos, onQty, onRemove }) {
      const enriched = items.map((it) => ({ ...it, product: productos.find((p) => p.productId === it.productId) })).filter((i) => i.product);
      const total = enriched.reduce((sum, it) => sum + it.qty * (it.product ? it.product.price || 0 : 0), 0);
      return (
        <div className="panel">
          <div className="row" style={{ justifyContent: "space-between", alignItems: "center" }}>
            <div className="badge">Carrito</div>
            <small>{enriched.length} items</small>
          </div>
          <div className="list">
            {enriched.map((it) => (
              <div className="item" key={it.productId}>
                <div>
                  <div>{it.product.productTitle}</div>
                  <div className="muted">EAN: {it.product.ean}</div>
                  <div className="muted">{money(it.product.price)} x {it.qty}</div>
                </div>
                <div style={{ display: "grid", gap: 6, justifyItems: "end" }}>
                  <div className="pill">{money(it.product.price * it.qty)}</div>
                  <div className="row">
                    <button className="btn secondary" onClick={() => onQty(it.productId, Math.max(1, it.qty - 1))}>-</button>
                    <button className="btn secondary" onClick={() => onQty(it.productId, it.qty + 1)}>+</button>
                    <button className="btn" style={{ background: "#ef4444", boxShadow: "none" }} onClick={() => onRemove(it.productId)}>Quitar</button>
                  </div>
                </div>
              </div>
            ))}
            {enriched.length === 0 && <div className="muted">El carrito está vacío.</div>}
          </div>
          <div className="cart-summary">
            <div>Total</div>
            <div className="pill" style={{ background: "rgba(6, 182, 212, 0.12)", color: "#e0f2fe", borderColor: "rgba(14, 165, 233, 0.35)" }}>{money(total)}</div>
          </div>
        </div>
      );
    }

    function App() {
      const { productos, loading, error } = useProductos();
      const [query, setQuery] = useState("");
      const [carrito, setCarrito] = useState(() => loadCarrito());
      const [toast, setToast] = useState(null);
      const lastAutoAddRef = useRef(0);
      const toastTimerRef = useRef(null);
      const pdfBusyRef = useRef(false);

      const showToast = useCallback((msg) => {
        if (toastTimerRef.current) clearTimeout(toastTimerRef.current);
        setToast(msg);
        toastTimerRef.current = setTimeout(() => setToast(null), 2800);
      }, []);

      const addToCart = useCallback((product) => {
        setCarrito((prev) => {
          const existing = prev.find((p) => p.productId === product.productId);
          if (existing) return prev.map((p) => p.productId === product.productId ? { ...p, qty: p.qty + 1 } : p);
          return [...prev, { productId: product.productId, qty: 1 }];
        });
      }, []);

      const addFromEan = useCallback((ean, enforceThrottle = false) => {
        const product = productos.find((p) => p.ean === ean);
        if (!product) { showToast("EAN no encontrado"); return; }
        if (enforceThrottle) {
          const now = Date.now();
          if (now - lastAutoAddRef.current < THROTTLE_MS) return;
          lastAutoAddRef.current = now;
        }
        addToCart(product);
      }, [productos, addToCart, showToast]);

      useEffect(() => { saveCarrito(carrito); }, [carrito]);

      useEffect(() => {
        const handler = (event) => {
          const ean = event.detail && event.detail.ean;
          if (ean) { setQuery(ean); addFromEan(ean, true); }
        };
        window.addEventListener("ean-detected", handler);
        return () => window.removeEventListener("ean-detected", handler);
      }, [addFromEan]);

      const filtered = useMemo(() => {
        const base = !query.trim()
          ? productos
          : productos.filter((p) =>
              p.productTitle.toLowerCase().includes(query.toLowerCase()) ||
              p.productName.toLowerCase().includes(query.toLowerCase()) ||
              p.ean.includes(query)
            );
        return base.slice(0, 5);
      }, [query, productos]);

      const setQty = (productId, qty) => setCarrito((prev) => prev.map((p) => p.productId === productId ? { ...p, qty } : p));
      const removeItem = (productId) => setCarrito((prev) => prev.filter((p) => p.productId !== productId));

      const handleEanFromField = () => {
        const ean = query.trim();
        if (!ean) return;
        addFromEan(ean, false);
      };

      const fetchImageData = useCallback(async (url) => {
        try {
          const res = await fetch(url);
          const blob = await res.blob();
          return await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(blob);
          });
        } catch (e) { return null; }
      }, []);

      const generatePdf = useCallback(async () => {
        if (pdfBusyRef.current) return;
        pdfBusyRef.current = true;
        try {
          if (!window.jspdf || !window.JsBarcode) { showToast("PDF no disponible en este navegador"); return; }
          const doc = new window.jspdf.jsPDF();
          const colX = [14, 110];
          const rowHeight = 55;
          const maxPerPage = 10;
          const startY = 18;

          for (let i = 0; i < productos.length; i++) {
            const p = productos[i];
            if (i % maxPerPage === 0 && i !== 0) doc.addPage();
            const col = i % 2;
            const rowInPage = Math.floor((i % maxPerPage) / 2);
            const x = colX[col];
            const y = startY + rowHeight * rowInPage;

            const imgData = await fetchImageData(p.imageUrl);
            if (imgData) {
              doc.addImage(imgData, "PNG", x, y - 2, 26, 26);
            } else {
              doc.setDrawColor(180);
              doc.rect(x, y - 2, 26, 26);
              doc.text("IMG", x + 6, y + 12);
            }

            doc.setFontSize(12);
            doc.text(p.productTitle || p.productName, x + 30, y + 6);
            doc.setFontSize(10);
            doc.text("EAN: " + p.ean, x + 30, y + 12);
            doc.text("Precio: " + money(p.price || 0), x + 30, y + 18);

            const canvas = document.createElement("canvas");
            try { window.JsBarcode(canvas, p.ean, { format: "EAN13", width: 1, height: 16, displayValue: false, margin: 0 }); }
            catch { window.JsBarcode(canvas, p.ean, { format: "CODE128", width: 1, height: 16, displayValue: false, margin: 0 }); }
            const hiRes = document.createElement("canvas");
            hiRes.width = canvas.width * 2;
            hiRes.height = canvas.height * 2;
            const hiCtx = hiRes.getContext("2d");
            hiCtx.drawImage(canvas, 0, 0, hiRes.width, hiRes.height);
            const img = hiRes.toDataURL("image/png");
            const naturalW = hiRes.width || 1;
            const naturalH = hiRes.height || 1;
            const targetW = 35;
            const targetH = targetW * (naturalH / naturalW);
            doc.addImage(img, "PNG", x + 30, y + 24, targetW, targetH);
          }
          doc.save("catalogo-productos.pdf");
        } catch (e) {
          console.error("PDF error", e);
          showToast("No se pudo generar el PDF");
        } finally { pdfBusyRef.current = false; }
      }, [productos, fetchImageData, showToast]);

      return (
        <div className="shell">
          <div className="row" style={{ justifyContent: "space-between", alignItems: "center", gap: 12 }}>
            <div>
              <h1>Caja Registradora</h1>
              <p>Un solo campo para búsqueda o EAN, escáner en vivo y carrito persistente.</p>
            </div>
            <button className="btn secondary" onClick={generatePdf}>Catalogo</button>
          </div>

          <BarcodeScanner onEan={(ean) => { setQuery(ean); addFromEan(ean, true); }} />

          <div className="grid">
            <div className="panel" style={{ padding: 0 }}>
              <div style={{ padding: 16 }}>
                <Buscador query={query} setQuery={setQuery} onAddEan={handleEanFromField} />
                {loading && <div className="muted" style={{ padding: "0 16px 12px" }}>Cargando productos…</div>}
                {error && <div className="error" style={{ padding: "0 16px 12px" }}>{error}</div>}
              </div>
              <div style={{ padding: 16, paddingTop: 0 }}>
                <ListaProductos items={filtered} onAdd={addToCart} />
              </div>
            </div>
            <Carrito items={carrito} productos={productos} onQty={setQty} onRemove={removeItem} />
          </div>
          {toast && <div className="toast">{toast}</div>}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
